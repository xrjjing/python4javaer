# 模块化与服务化规划（计划）

> 本文用于记录当前仓库在 RBAC 抽离后的整体模块化规划，方便后续查询与扩展。

## 一、整体目标

- 在保持“项目实战”教学节奏的前提下，逐步将通用能力抽成可复用模块或独立服务；
- 以当前 `rbac_auth_service` 为基准，统一各服务内部结构，降低心智负担；
- 不追求一开始就微服务化，而是以“可演进的模块化”为主线。

## 二、当前基础：RBAC 鉴权服务

- 已抽出的模块：`rbac_auth_service/`
  - 技术栈：FastAPI + SQLAlchemy + JWT（+ 可选 Redis）
  - 主要能力：
    - 用户、角色、权限的 RBAC 模型与管理接口；
    - 基于依赖注入的权限控制（require_roles / require_permissions 等）；
    - 示例 Todo 业务，演示资源级权限控制；
    - 初始数据脚本与基础 API 测试用例。
  - 内部结构（后续其他服务的参考模板）：
    - `app/main.py`：FastAPI 入口
    - `app/config.py`：配置管理（数据库、JWT、Redis 等）
    - `app/database.py`：数据库会话与连接管理
    - `app/models.py` / `app/schemas.py`：领域模型与 Pydantic 模型
    - `app/repositories/`：存储访问层
    - `app/services/`：业务服务层
    - `app/routers/`：路由与控制器
    - `app/dependencies.py`：依赖注入（当前用户、权限检查等）
    - `app/security.py`：密码哈希、JWT 生成与校验、Token 黑名单等

## 三、适合单独抽出的其他模块/服务

### 1. 日志 / 审计 / 报表模块（log_audit_service）

- 相关现有内容：
  - `03.项目实战/02_日志分析与报表生成`
  - `03.项目实战/06_自动化脚本_日志归档`
  - `03.项目实战/C_日志分析_排障与报表`
- 规划方向：
  - 抽象为一个专门处理日志与审计的服务或模块：
    - 接收业务服务（包括 RBAC 服务）发送的操作日志与访问日志；
    - 提供基础的日志查询接口（按用户、接口、时间范围等过滤）；
    - 提供简单报表统计接口（错误率、访问量、按用户或接口聚合）；
  - 后续可以扩展：
    - 增加日志归档策略（冷热分层、定时归档）；
    - 支持导出报表或接入可视化工具。

### 2. 定时任务 / 批处理模块（job_scheduler_service 或 scheduler）

- 相关现有内容：
  - `03.项目实战/B_批处理任务_定时与脚本`
  - `03.项目实战/06_自动化脚本_日志归档`
- 规划方向：
  - 提供统一的“任务调度中心”能力：
    - 封装定时任务调度（如 APScheduler / Celery Beat 等）；
    - 定义统一的任务描述（任务名、参数、执行函数/脚本路径）；
  - 与其他服务的关系：
    - 日志服务可以在此注册“日志归档”任务；
    - RBAC 或业务服务可以注册周期性清理任务（如过期会话、黑名单清理等）。

### 3. 系统对接 / 网关模块（integration_gateway_service）

- 相关现有内容：
  - `03.项目实战/A_写接口_接口开发与网关`
  - `03.项目实战/D_系统对接_内部与第三方`
  - `03.项目实战/08_系统对接_调用Java服务API`
- 规划方向：
  - 抽象为“系统对接网关”服务：
    - 对外提供统一的 HTTP API，用于代理或聚合内部/第三方服务；
    - 内部统一实现：签名、认证、重试、超时、熔断、日志与监控等横切能力；
  - 与 RBAC 的配合：
    - 所有对接接口统一接入 RBAC 鉴权（根据用户角色/权限限制对外能力）；
    - 审计日志写入日志服务（记录谁调用了哪个外部系统、是否成功等）。

### 4. 监控指标与告警模块（monitoring_service）

- 相关现有内容：
  - `03.项目实战/07_监控数据处理_指标聚合与告警`
- 规划方向：
  - 提供基础的监控与告警能力：
    - 接收从业务服务上报的指标（QPS、响应时间、错误数量等）；
    - 做简单的聚合与窗口统计；
    - 根据阈值触发告警动作（例如写入日志、发送邮件/钉钉等）。
  - 与其他模块的关系：
    - 网关服务上报接口调用成功率与延迟；
    - RBAC 服务上报登录失败次数等安全相关指标；
    - 日志服务也可将异常情况通过指标形式上报。

### 5. 通用 CLI / 工具库模块（common_cli_tools 或 file_utils）

- 相关现有内容：
  - `03.项目实战/01_命令行工具_批量重命名文件`
  - 其他目录中重复使用的文件与目录操作脚本
- 规划方向：
  - 将常用的脚本能力整理为一个通用工具包：
    - 批量重命名、日志切割、简单文件统计等；
  - 使用方式：
    - 打包为 Python 包，在本仓库内以 `pip install -e .` 的形式被其他项目引用；
    - 也可以提供一组命令行入口，便于直接在命令行使用。

## 四、服务内部统一结构规划

为降低学习成本，后续新抽出的服务建议遵循与 `rbac_auth_service` 一致或相近的目录结构：

- `app/main.py`：FastAPI 入口（或 CLI/脚本入口）
- `app/config.py`：配置加载与管理（数据库、外部服务地址、认证参数等）
- `app/database.py`：数据库连接与会话管理（如服务需要持久化）
- `app/models.py`：核心领域模型定义（SQLAlchemy 或其他 ORM）
- `app/schemas.py`：Pydantic 模型（请求/响应/内部 DTO）
- `app/repositories/`：数据访问层（封装对数据库或外部存储的操作）
- `app/services/`：业务逻辑层（组合仓储操作与领域规则）
- `app/routers/`：API 路由与控制器
- `app/dependencies.py`：依赖注入（当前用户、会话、权限、外部客户端等）
- `app/security.py`：只有需要安全相关能力（认证/签名/加解密）的服务才需要

## 五、跨模块的“公共层”规划：common 包

- 在仓库根目录规划一个 `common/` 包，作为“尚未独立成服务的通用能力缓冲区”：
  - 放置与业务无关的通用组件：
    - 日志封装（统一 logger、trace id 等）；
    - 通用 HTTP 客户端封装（重试、超时、统一错误处理）；
    - 通用配置加载工具（环境变量、.env 文件等）。
- 使用原则：
  - 先将重复逻辑抽取到 `common` 中，被多个项目/服务引用；
  - 当某块能力复杂度提升时，再从 `common` 中升级为独立服务（如监控、网关等）。

## 六、推荐的演进顺序

在现有 RBAC 服务已独立的前提下，建议以下演进顺序逐步推进模块化：

1. **第一步：抽出“系统对接 / 网关模块（integration_gateway_service）”**
   - 目标：把“对内 RBAC 控制 + 对外 Java/第三方调用”打通成一个完整闭环；
   - 做法：
     - 在仓库根目录新建 `integration_gateway_service/`，按统一结构搭建服务框架；
     - 整理 `A_写接口_接口开发与网关` 与 `08_系统对接_调用Java服务API` 的示例代码，迁移到该服务；
     - 对所有网关路由接入 RBAC 的鉴权依赖，并在关键操作处写入审计日志（先写本地日志，未来接日志服务）。

2. **第二步：抽出“日志 / 审计模块（log_audit_service）”**
   - 目标：为 RBAC 与网关等服务提供统一的日志与审计能力；
   - 做法：
     - 在仓库根目录新建 `log_audit_service/`，整合日志分析与报表相关代码；
     - 先实现“写日志 + 查日志”的基础 REST 接口，再逐步增强报表统计；
     - 调整 RBAC 与网关，在关键操作处调用日志服务接口。

3. **第三步：根据精力选择“定时任务模块”或“监控指标模块”**
   - 如果更关注“自动化运维与任务调度”，优先做 `job_scheduler_service`；
   - 如果更关注“系统稳定性与告警”，优先做 `monitoring_service`；
   - 两者都可以先以简单脚本 + 配置的形式实现，后续再升级为完整独立服务。

4. **第四步：整理通用 CLI / 工具库到 common 包**
   - 将重复使用的文件操作、日志归档等脚本提取为 `common` 中的工具模块；
   - 为这些工具增加简单的单元测试与文档，保证可复用性。

## 七、后续使用说明

- 本文档作为"模块化与服务化规划"的基础版本，后续每次新增或调整模块时，可以在本文件中追加或修订对应章节；
- 后续如有新的想法（例如引入消息队列、API 网关组件、配置中心等），也可以先在此文档中做"规划草图"，再根据实际需要落地实现。

---

## 八、2025-11 补充规划：内容完善与学习体验优化

> 本节记录本次审查后识别的待补齐项，按优先级排列。

### 已完成项

- [x] ~~补齐 Chapter 15 正则表达式说明文档 (`01_正则表达式/正则表达式.md`)~~
- [x] ~~清理 demo_operators.py 中的 TODO 占位符~~
- [x] ~~新增 `frontend/login.html` 登录页面~~
- [x] ~~新增 `frontend/admin.html` Admin Dashboard~~
- [x] ~~在 `15_进阶专题.md` 新增综合实战练习（审计日志分析与报表生成）~~
- [x] ~~为已完成子专题添加"在本仓库中的应用"（正则、标准库、数据序列化、异步编程）~~
- [x] ~~在 index.html RBAC 章节增加 login/admin 入口按钮~~
- [x] ~~新增 `frontend/README.md`（启动方式、API配置、安全注意事项）~~
- [x] ~~**2025-12-01 新增**：补齐 `log_detective_service` 文档和测试~~
  - [x] ~~创建 `log_detective_service/09_项目说明.md`（9个标准章节）~~
  - [x] ~~创建 `log_detective_service/test_log_detective_service.py`（11个测试用例，覆盖率77%）~~
  - [x] ~~更新根 `README.md`（添加第5个微服务）~~
  - [x] ~~更新 `网关_RBAC_后端联调说明.md`（添加服务说明链接）~~
  - [x] ~~更新 `frontend/README.md`（添加 log-detective.html 映射关系）~~
- [x] ~~**2025-12-01 新增**：结构对齐与代码重构~~
  - [x] ~~`log_detective_service`: `routes.py` → `routers/log_detective.py`~~
  - [x] ~~`integration_gateway_service`: 新增 `log_detective_client.py`~~
  - [x] ~~网关路由重构：使用依赖注入模式调用日志侦探服务~~
- [x] ~~**2025-12-01 新增**：前端安全修复~~
  - [x] ~~修复 `common.js` 中的 XSS 漏洞（innerHTML → DOM API + textContent）~~
  - [x] ~~创建 `frontend/config.js` 统一配置文件~~
  - [x] ~~更新所有 HTML 文件使用 AppConfig~~
  - [x] ~~添加向后兼容支持（API_BASE_URL fallback）~~
  - [x] ~~更新 `frontend/README.md` 配置说明~~
- [x] ~~**2025-12-01 新增**：架构文档与图表~~
  - [x] ~~创建 `docs/architecture.md`（含 Mermaid 图、服务说明、调用流程）~~
  - [x] ~~在根 `README.md` 添加 ASCII 架构总览图~~
  - [x] ~~标注教学要点（JWT流、审计流、网关转发模式）~~

### 待完成项（按优先级）

#### 优先级 1：文档一致性修复

1. ~~**端口统一**~~ ✅ ~~已完成~~
   - ~~已统一为 8002：`15_进阶专题.md`、`admin.html`~~

2. ~~**补齐剩余子专题的"在本仓库中的应用"**~~ ✅ ~~已完成~~
   - ~~文件与目录操作深入.md~~
   - ~~网络编程基础.md~~
   - ~~多线程与多进程.md~~

#### 优先级 2：前端安全增强

3. ~~**XSS 风险消除**~~ ✅ ~~已完成（2025-12-01）~~
   - ~~admin.html 中 innerHTML 渲染用户数据，存在潜在 XSS~~
   - ~~改用 DOM API + textContent 构建表格行~~
   - ~~创建统一配置文件 config.js~~

#### 优先级 3：前端与服务集成

4. ~~**端到端练习入口**~~ ✅ ~~已完成~~
   - ~~在 `网关_RBAC_后端联调说明.md` 新增"五、进阶练习：四服务全链路联调"~~
   - ~~包含：启动4服务 + 前端 → 登录 → 管理 → 网关调用 → 审计日志查看~~

#### 优先级 3：文档更新

6. ~~**更新顶层 README**~~ ✅ ~~已完成（2025-12-01）~~
   - ~~补充 Chapter 15 现状~~
   - ~~补充新前端页面说明~~
   - ~~给出推荐学习路径~~
   - ~~添加 log_detective_service 到服务列表~~
   - ~~更新微服务启动命令（5个服务）~~

#### 优先级 4：测试与质量

7. **补充关键测试**
   - integration_gateway_service 主路径测试
   - 前端 API 交互契约测试脚本

#### 优先级 5：学习价值增强

8. **Java 对比视角附录**
   - 正则：Python re vs Java regex
   - 并发：asyncio vs CompletableFuture
   - Web：FastAPI vs Spring Boot

9. **挑战任务列表**
   - 为各章节/模块增加开放式练习任务

---

## 九、FastAPI 深度专题模块开发计划（2025-12-03）

> 本节记录 FastAPI 深度学习模块的开发规划，按 Phase 1/2 分阶段推进。

### 模块定位

- **目标用户**：Java 开发者转 Python/FastAPI
- **学习形式**：理论章节 + 配套实验室练习 + 前端导航
- **技术协作**：Claude 统筹 + Codex 内容生成/审查 + Gemini 前端设计

### Phase 1：核心概念（已部分完成）

#### ✅ 已完成项

1. **模块基础架构**
   - [x] 创建目录结构 `02.开发环境及框架介绍/04_FastAPI_深度专题/`
   - [x] 编写模块 README.md（学习路线、进度追踪、快速开始）
   - [x] 规划 11 章理论 + 5 个实验室练习

2. **第2章：路由与依赖注入进阶**
   - [x] 完整章节文档（3000+ 字）
     - Spring Boot DI vs FastAPI Depends 对比表
     - APIRouter 拆分模式（Before/After 示例）
     - 多级依赖链详解（配置→引擎→Session→仓储→路由）
     - 依赖覆盖测试实战（dependency_overrides）
     - 生命周期管理（lifespan + yield）
     - 常见陷阱 + 最佳实践 + 4 个练习任务
   - [x] Java vs Python 小贴士（作用域心智、配置注入、拦截器、MockBean）

3. **lab01_router_splitting 实验**
   - [x] 完整可运行代码（users/products/health 三个 router）
   - [x] 依赖注入示例（共享 FakeDB）
   - [x] pytest 测试用例（覆盖所有接口 + 404 场景）
   - [x] README 实验说明（目标、步骤、验收清单）
   - [x] Codex 代码审查通过（无 bug，质量良好）

4. **前端学习导航**
   - [x] `frontend/fastapi-course/index.html`（主导航页面）
   - [x] `frontend/fastapi-course/css/course.css`（响应式样式 + 暗色模式）
   - [x] `frontend/fastapi-course/js/navigation.js`（交互逻辑）
   - [x] 功能特性：
     - 侧边栏导航（Phase 1/2 章节 + 实验室）
     - 进度条（当前 20%）
     - 面包屑导航
     - 暗色模式切换
     - 移动端响应式
     - Prism.js 语法高亮集成

#### ⏳ 待完成项（Phase 1）

5. **第3章：数据模型与校验_Pydantic2** ✅ 已完成（2025-12-04）
   - [x] 章节文档编写（12节，含对照表、代码示例、测试片段）
   - [x] 校验模型、字段约束示例（Field参数、内建类型）
   - [x] 自定义校验器（@field_validator、@model_validator）
   - [x] 嵌套模型与判别联合类型（discriminator）
   - [x] Settings/环境变量配置（BaseSettings + pydantic-settings）
   - [x] 模型转换/序列化（别名详解、ORM转换、strict模式）
   - [x] Java Bean Validation vs Pydantic 对比（完整对照表）
   - [x] 4个练习任务 + pytest 示例
   - [x] Codex 代码审查通过

6. **第4章：数据库与事务** ✅ 已完成（2025-12-04）
   - [x] 章节文档编写（13节，约4000字）
   - [x] Sync vs Async SQLAlchemy 对比
   - [x] Session 管理模式（DI 集成）
   - [x] 事务控制与回滚（含嵌套事务/Savepoint）
   - [x] 连接池配置（pool_size/max_overflow/pool_pre_ping）
   - [x] 关系加载策略（lazy/selectinload/joinedload）
   - [x] JPA/Hibernate/HikariCP 对比表
   - [x] 4个练习任务
   - [x] Codex 代码审查通过

7. **第5章：认证与授权** ✅ 已完成（2025-12-04）
   - [x] 章节文档编写（13节，约4500字）
   - [x] OAuth2 Password Flow + JWT 实现
   - [x] 密码哈希（passlib + bcrypt）
   - [x] Access + Refresh Token 双令牌模式
   - [x] RBAC 依赖注入（require_role / require_permission）
   - [x] Token 吊销与黑名单策略
   - [x] Spring Security 对比表
   - [x] 完整可运行示例
   - [x] 4个练习任务
   - [x] Codex 代码审查通过

8. **lab02_dep_chain_override 实验** ✅ 已完成（2025-12-04）
   - [x] 实现配置→引擎→Session→仓储→路由依赖链
   - [x] 编写内存 SQLite 覆盖测试（10个测试用例）
   - [x] 验证 CRUD 不触碰真实 DB（init_db=False 机制）
   - [x] 完整 README 文档
   - [x] Codex 代码审查通过

### Phase 2：进阶特性（待开始）

#### ⏳ 待完成项（Phase 2）

9. **第6章：中间件与跨切面** ✅ 已完成（2025-12-04）
   - [x] CORS 配置
   - [x] 统一日志中间件
   - [x] 请求耗时追踪
   - [x] 全局异常处理
   - [x] 限流/幂等键思路
   - [x] Request ID / contextvars（类似 Java MDC）
   - [x] Java Filter/Interceptor 对照
   - [x] 完整可运行示例
   - [x] Codex 代码审查通过

10. **第7章：异步与背景任务** ✅ 已完成（2025-12-04）
    - [x] 异步基础回顾（async/await vs sync）
    - [x] BackgroundTasks 使用（fire-and-forget）
    - [x] 长任务状态跟踪（内存版 + 生产建议）
    - [x] 重试策略（装饰器 + 幂等性）
    - [x] 并发控制（Semaphore + 超时）
    - [x] Celery/Redis 集成触点
    - [x] 可观测性（Trace ID 传递）
    - [x] Java CompletableFuture / @Async 对照
    - [x] 完整可运行示例（任务取消 + 生命周期管理）
    - [x] Codex 代码审查通过

11. **第8章：WebSocket与实时推送** ✅ 已完成（2025-12-04）
    - [x] WebSocket 基础（vs HTTP 长轮询对比）
    - [x] 连接生命周期管理（ConnectionManager + 房间模式）
    - [x] 心跳与保活（Ping/Pong 机制）
    - [x] 重连策略（客户端指数退避）
    - [x] 认证（基于 Token 的 WebSocket 认证）
    - [x] 流量控制与消息大小限制
    - [x] 水平扩展（Redis Pub/Sub）
    - [x] 安全与合规（XSS 防护、连接数限制）
    - [x] Java Spring WebSocket/STOMP 对照
    - [x] 完整可运行示例（含 HTML 测试客户端）
    - [x] Codex 代码审查通过（修复7个问题）

12. **第9章：测试与Mock**
    - [ ] TestClient 深入使用
    - [ ] 依赖覆盖策略
    - [ ] 内存 DB 测试
    - [ ] 外部服务 Fake/Mock
    - [ ] 性能基线测试

13. **lab03_async_sqlalchemy 实验**
    - [ ] 同步 CRUD 改造为异步
    - [ ] 测试并发与连接池

14. **lab04_websocket_chat 实验**
    - [ ] 最小聊天室/通知推送
    - [ ] 心跳与房间管理
    - [ ] 前端 WebSocket 调试页面

15. **lab05_jwt_rbac 实验**
    - [ ] 登录、发放/刷新 Token
    - [ ] 基于角色的路由保护
    - [ ] 前端 JWT 调试器界面

### 前端优化（后续改进）

#### ⏳ 待改进项

16. **内容加载增强**
    - [ ] 实现 Markdown 文件动态加载（使用 marked.js）
    - [ ] 点击章节直接在页面内查看内容
    - [ ] 代码块语法高亮自动应用

17. **进度管理**
    - [ ] 将导航配置抽象为 JSON 数据源
    - [ ] 自动统计完成进度
    - [ ] localStorage 保存学习进度

18. **交互组件**
    - [ ] "Try It" 按钮（调用本地 FastAPI 服务）
    - [ ] Java 对照切换组件
    - [ ] Mermaid.js 序列图可视化

### 质量保障

#### ✅ 已完成

- [x] Codex 代码审查（lab01）
- [x] 路径一致性检查
- [x] 文档结构统一
Markdown Preview Enhanced
#### ⏳ 待补充

- [ ] 为所有 labs 补充完整测试
- [ ] 前端与后端集成测试
- [ ] 文档 lint 检查

### 使用说明

**查看已完成内容：**
```bash
# 阅读第2章
cat "02.开发环境及框架介绍/04_FastAPI_深度专题/02_路由与依赖注入进阶.md"

# 运行 lab01
cd "02.开发环境及框架介绍/04_FastAPI_深度专题/labs/lab01_router_splitting"
pip install fastapi uvicorn pytest
uvicorn app.main:app --reload

# 查看前端导航
cd frontend && python -m http.server 5500
# 访问 http://127.0.0.1:5500/fastapi-course/
```

**继续开发：**
- 按 Phase 1 → Phase 2 顺序完成剩余章节
- 每完成一章，更新 README 和前端导航状态
- 使用 Codex 进行代码审查
- 使用 Gemini 优化前端交互

### 备注

- **协作模式**：Claude 统筹 + Codex（gpt-5.1-codex-max）技术 + Gemini 前端
- **文档风格**：中文文档 + 英文代码 + Java 对比
- **质量标准**：可运行、可测试、教育价值高
