# 模块化与服务化规划（计划）

> 本文用于记录当前仓库在 RBAC 抽离后的整体模块化规划，方便后续查询与扩展。

## 一、整体目标

- 在保持“项目实战”教学节奏的前提下，逐步将通用能力抽成可复用模块或独立服务；
- 以当前 `rbac_auth_service` 为基准，统一各服务内部结构，降低心智负担；
- 不追求一开始就微服务化，而是以“可演进的模块化”为主线。

## 二、当前基础：RBAC 鉴权服务

- 已抽出的模块：`rbac_auth_service/`
  - 技术栈：FastAPI + SQLAlchemy + JWT（+ 可选 Redis）
  - 主要能力：
    - 用户、角色、权限的 RBAC 模型与管理接口；
    - 基于依赖注入的权限控制（require_roles / require_permissions 等）；
    - 示例 Todo 业务，演示资源级权限控制；
    - 初始数据脚本与基础 API 测试用例。
  - 内部结构（后续其他服务的参考模板）：
    - `app/main.py`：FastAPI 入口
    - `app/config.py`：配置管理（数据库、JWT、Redis 等）
    - `app/database.py`：数据库会话与连接管理
    - `app/models.py` / `app/schemas.py`：领域模型与 Pydantic 模型
    - `app/repositories/`：存储访问层
    - `app/services/`：业务服务层
    - `app/routers/`：路由与控制器
    - `app/dependencies.py`：依赖注入（当前用户、权限检查等）
    - `app/security.py`：密码哈希、JWT 生成与校验、Token 黑名单等

## 三、适合单独抽出的其他模块/服务

### 1. 日志 / 审计 / 报表模块（log_audit_service）

- 相关现有内容：
  - `03.项目实战/02_日志分析与报表生成`
  - `03.项目实战/06_自动化脚本_日志归档`
  - `03.项目实战/C_日志分析_排障与报表`
- 规划方向：
  - 抽象为一个专门处理日志与审计的服务或模块：
    - 接收业务服务（包括 RBAC 服务）发送的操作日志与访问日志；
    - 提供基础的日志查询接口（按用户、接口、时间范围等过滤）；
    - 提供简单报表统计接口（错误率、访问量、按用户或接口聚合）；
  - 后续可以扩展：
    - 增加日志归档策略（冷热分层、定时归档）；
    - 支持导出报表或接入可视化工具。

### 2. 定时任务 / 批处理模块（job_scheduler_service 或 scheduler）

- 相关现有内容：
  - `03.项目实战/B_批处理任务_定时与脚本`
  - `03.项目实战/06_自动化脚本_日志归档`
- 规划方向：
  - 提供统一的“任务调度中心”能力：
    - 封装定时任务调度（如 APScheduler / Celery Beat 等）；
    - 定义统一的任务描述（任务名、参数、执行函数/脚本路径）；
  - 与其他服务的关系：
    - 日志服务可以在此注册“日志归档”任务；
    - RBAC 或业务服务可以注册周期性清理任务（如过期会话、黑名单清理等）。

### 3. 系统对接 / 网关模块（integration_gateway_service）

- 相关现有内容：
  - `03.项目实战/A_写接口_接口开发与网关`
  - `03.项目实战/D_系统对接_内部与第三方`
  - `03.项目实战/08_系统对接_调用Java服务API`
- 规划方向：
  - 抽象为“系统对接网关”服务：
    - 对外提供统一的 HTTP API，用于代理或聚合内部/第三方服务；
    - 内部统一实现：签名、认证、重试、超时、熔断、日志与监控等横切能力；
  - 与 RBAC 的配合：
    - 所有对接接口统一接入 RBAC 鉴权（根据用户角色/权限限制对外能力）；
    - 审计日志写入日志服务（记录谁调用了哪个外部系统、是否成功等）。

### 4. 监控指标与告警模块（monitoring_service）

- 相关现有内容：
  - `03.项目实战/07_监控数据处理_指标聚合与告警`
- 规划方向：
  - 提供基础的监控与告警能力：
    - 接收从业务服务上报的指标（QPS、响应时间、错误数量等）；
    - 做简单的聚合与窗口统计；
    - 根据阈值触发告警动作（例如写入日志、发送邮件/钉钉等）。
  - 与其他模块的关系：
    - 网关服务上报接口调用成功率与延迟；
    - RBAC 服务上报登录失败次数等安全相关指标；
    - 日志服务也可将异常情况通过指标形式上报。

### 5. 通用 CLI / 工具库模块（common_cli_tools 或 file_utils）

- 相关现有内容：
  - `03.项目实战/01_命令行工具_批量重命名文件`
  - 其他目录中重复使用的文件与目录操作脚本
- 规划方向：
  - 将常用的脚本能力整理为一个通用工具包：
    - 批量重命名、日志切割、简单文件统计等；
  - 使用方式：
    - 打包为 Python 包，在本仓库内以 `pip install -e .` 的形式被其他项目引用；
    - 也可以提供一组命令行入口，便于直接在命令行使用。

## 四、服务内部统一结构规划

为降低学习成本，后续新抽出的服务建议遵循与 `rbac_auth_service` 一致或相近的目录结构：

- `app/main.py`：FastAPI 入口（或 CLI/脚本入口）
- `app/config.py`：配置加载与管理（数据库、外部服务地址、认证参数等）
- `app/database.py`：数据库连接与会话管理（如服务需要持久化）
- `app/models.py`：核心领域模型定义（SQLAlchemy 或其他 ORM）
- `app/schemas.py`：Pydantic 模型（请求/响应/内部 DTO）
- `app/repositories/`：数据访问层（封装对数据库或外部存储的操作）
- `app/services/`：业务逻辑层（组合仓储操作与领域规则）
- `app/routers/`：API 路由与控制器
- `app/dependencies.py`：依赖注入（当前用户、会话、权限、外部客户端等）
- `app/security.py`：只有需要安全相关能力（认证/签名/加解密）的服务才需要

## 五、跨模块的“公共层”规划：common 包

- 在仓库根目录规划一个 `common/` 包，作为“尚未独立成服务的通用能力缓冲区”：
  - 放置与业务无关的通用组件：
    - 日志封装（统一 logger、trace id 等）；
    - 通用 HTTP 客户端封装（重试、超时、统一错误处理）；
    - 通用配置加载工具（环境变量、.env 文件等）。
- 使用原则：
  - 先将重复逻辑抽取到 `common` 中，被多个项目/服务引用；
  - 当某块能力复杂度提升时，再从 `common` 中升级为独立服务（如监控、网关等）。

## 六、推荐的演进顺序

在现有 RBAC 服务已独立的前提下，建议以下演进顺序逐步推进模块化：

1. **第一步：抽出“系统对接 / 网关模块（integration_gateway_service）”**
   - 目标：把“对内 RBAC 控制 + 对外 Java/第三方调用”打通成一个完整闭环；
   - 做法：
     - 在仓库根目录新建 `integration_gateway_service/`，按统一结构搭建服务框架；
     - 整理 `A_写接口_接口开发与网关` 与 `08_系统对接_调用Java服务API` 的示例代码，迁移到该服务；
     - 对所有网关路由接入 RBAC 的鉴权依赖，并在关键操作处写入审计日志（先写本地日志，未来接日志服务）。

2. **第二步：抽出“日志 / 审计模块（log_audit_service）”**
   - 目标：为 RBAC 与网关等服务提供统一的日志与审计能力；
   - 做法：
     - 在仓库根目录新建 `log_audit_service/`，整合日志分析与报表相关代码；
     - 先实现“写日志 + 查日志”的基础 REST 接口，再逐步增强报表统计；
     - 调整 RBAC 与网关，在关键操作处调用日志服务接口。

3. **第三步：根据精力选择“定时任务模块”或“监控指标模块”**
   - 如果更关注“自动化运维与任务调度”，优先做 `job_scheduler_service`；
   - 如果更关注“系统稳定性与告警”，优先做 `monitoring_service`；
   - 两者都可以先以简单脚本 + 配置的形式实现，后续再升级为完整独立服务。

4. **第四步：整理通用 CLI / 工具库到 common 包**
   - 将重复使用的文件操作、日志归档等脚本提取为 `common` 中的工具模块；
   - 为这些工具增加简单的单元测试与文档，保证可复用性。

## 七、后续使用说明

- 本文档作为“模块化与服务化规划”的基础版本，后续每次新增或调整模块时，可以在本文件中追加或修订对应章节；
- 后续如有新的想法（例如引入消息队列、API 网关组件、配置中心等），也可以先在此文档中做“规划草图”，再根据实际需要落地实现。

