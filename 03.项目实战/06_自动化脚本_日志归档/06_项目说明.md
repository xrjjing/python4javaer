# 06_自动化脚本_日志归档

> 目标：编写一个自动化脚本，对指定目录下「超过 N 天的日志文件」进行压缩归档。练习 `pathlib`、`datetime`、`zipfile`，并理解如何把 Python 脚本接入到定时任务（如 crontab）中。

## 1. 项目背景

在实际工作中，后台服务通常会生成大量日志，如果不定期归档：

- 占用大量磁盘空间；
- 查找历史日志困难；
- 影响备份效率。

常见做法是：

- 按日期生成日志文件；
- 定期将「过旧的日志」打包归档甚至删除。

本项目就模拟这样一个自动化场景。

## 2. 目录与文件说明

```text
03.项目实战/
└── 06_自动化脚本_日志归档/
    ├── 06_项目说明.md
    └── archive_old_logs.py    # 日志归档脚本
```

## 3. 功能需求（基础版）

- 指定一个日志目录，例如 `./logs`；
- 指定一个天数阈值，例如 7 天；
- 查找该目录下所有 `.log` 文件，如果「最后修改时间早于 N 天前」，就将它们打包成一个压缩包（zip）；
- 压缩完成后，可选择删除原始 `.log` 文件。

## 4. 运行方式

```bash
python 03.项目实战/06_自动化脚本_日志归档/archive_old_logs.py \
  --dir ./logs --days 7 --delete
```

脚本会在日志目录同级位置生成形如 `logs_archive_2025-01-01.zip` 的压缩文件。

## 5. 测试说明

- 本项目有一个基础测试文件：`test_archive_old_logs.py`。  
- 在仓库根目录运行下面命令可以只跑本项目的测试：

  ```bash
  pytest 03.项目实战/06_自动化脚本_日志归档/test_archive_old_logs.py
  ```

测试主要覆盖两部分：

- `find_old_logs`：通过手动修改文件的修改时间（mtime），检查是否能正确筛选出「超过 N 天」的日志；
- `archive_files`：调用后是否会生成包含指定文件名的 zip 包。

通过阅读测试用例，你可以更直观地理解脚本对「时间阈值」和归档结果的处理方式。

## 5. 如何与系统定时任务结合（思路）

- macOS / Linux：可使用 `crontab -e` 配置定时任务，例如每天凌晨执行一次此脚本；
- Windows：可以用「任务计划程序」定时调用 Python 脚本。

> 注意：在真正生产环境中使用前，一定要先在测试环境验证脚本逻辑，以免误删或误压缩重要文件。

## 6. 扩展练习

- 支持多种扩展名（如 `.log`、`.out`），并通过命令行参数配置；
- 归档完成后，将归档结果写入一个简单的日志文件，记录归档时间和文件数量；
- 当归档的文件总大小超过某个阈值时，发送一个简单的告警（例如打印提示或预留 HTTP 回调）。
