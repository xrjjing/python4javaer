# 日志与审计服务（log_audit_service）说明

## 一、项目定位

- 提供一个独立的“日志 / 审计”服务，用于集中记录来自 RBAC、网关以及其他业务服务的关键操作；
- 作为“模块化与服务化规划”中的日志模块实现示例，演示如何用 FastAPI + SQLAlchemy 搭建简单的日志服务。

## 二、目录结构

- `log_audit_service/app/`
  - `__init__.py`：应用包初始化。
  - `config.py`：配置管理（数据库连接字符串等）。
  - `database.py`：SQLAlchemy 引擎与会话管理。
  - `models.py`：审计日志数据库模型定义。
  - `schemas.py`：Pydantic 模型定义（创建与返回结构）。
  - `repositories/`
    - `__init__.py`：数据访问层包初始化。
    - `audit_log_repository.py`：审计日志的增删查逻辑（目前仅增与查）。
  - `routers/`
    - `__init__.py`：路由包初始化。
    - `audit_logs.py`：审计日志相关 API 路由。
  - `main.py`：FastAPI 入口，创建应用并挂载路由。

## 三、运行方式

1. 在仓库根目录安装依赖：

   ```bash
   pip install -r requirements.txt
   ```

2. 启动日志 / 审计服务（示例使用 8002 端口）：

   ```bash
   uvicorn log_audit_service.app.main:app --reload --port 8002
   ```

3. 访问接口文档：

   - `http://127.0.0.1:8002/docs`

## 四、配置说明

- 配置由 `app/config.py` 中的 `Settings` 管理，支持以下环境变量（带前缀 `LOG_AUDIT_`）：
  - `LOG_AUDIT_DATABASE_URL`：数据库连接字符串，默认 `sqlite:///./log_audit.db`；
- 示例 `.env` 片段：

```env
LOG_AUDIT_DATABASE_URL=sqlite:///./log_audit.db
```

## 五、提供的接口

### 1. 创建审计日志

- 路径：`POST /logs`
- 请求体：`AuditLogCreate`

  ```json
  {
    "actor": "alice",
    "action": "login",
    "resource": "user",
    "source_service": "rbac",
    "ip": "127.0.0.1",
    "detail": "用户 alice 登录成功"
  }
  ```

- 返回：`AuditLogRead`，包含生成的 `id` 与 `created_at` 等字段。

### 2. 查询审计日志列表

- 路径：`GET /logs`
- 查询参数（均为可选）：
  - `actor`：按操作主体精确过滤；
  - `action`：按操作名称精确过滤；
  - `source_service`：按来源服务名称精确过滤；
  - `since`：起始时间（含），ISO8601 字符串；
  - `until`：结束时间（含），ISO8601 字符串；
  - `limit`：返回数量上限（默认 50，最大 200）；
  - `offset`：偏移量，用于分页。

- 返回：`List[AuditLogRead]`，按时间倒序排列。

## 六、后续与其他服务的联动规划

- RBAC 服务：
  - 在用户登录、登出、角色/权限变更等敏感操作处调用 `POST /logs` 记录审计日志；
- 网关服务：
  - 在关键接口（如下单、支付、导出报表）前后调用日志服务，记录调用者、资源、请求来源 IP 等信息；
- 其他业务服务：
  - 可统一将关键业务事件发送到本日志服务，以便后续集中分析与排障。

