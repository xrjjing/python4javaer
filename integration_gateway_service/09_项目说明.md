# 系统对接网关服务（integration_gateway_service）说明

## 一、项目定位

- 作为“项目实战”中系统对接相关示例的升级版本，将原本分散在
  `A_写接口_接口开发与网关`、`D_系统对接_内部与第三方`、
  `08_系统对接_调用Java服务API` 中的思路，整理为一个独立的网关服务；
- 目标：演示如何在 Python 中实现一个 **通用 HTTP 网关层**，下游可以是任意语言实现的用户/订单等微服务，
  网关本身专注于认证、参数补充、错误处理与统一响应包装，并预留与 RBAC 鉴权服务集成的能力。

## 二、目录结构

- `integration_gateway_service/app/`
  - `__init__.py`：应用包初始化。
  - `main.py`：FastAPI 入口，创建应用实例并挂载路由。
  - `config.py`：网关服务配置（后端服务地址、RBAC JWT 配置等）。
  - `schemas.py`：Pydantic 模型定义（订单创建、统一响应结构等）。
  - `client_backend_service.py`：通用后端服务客户端封装，负责 HTTP 调用与错误处理。
  - `dependencies.py`：依赖注入（后端客户端、当前用户解析等）。
  - `routers/`：
    - `__init__.py`：路由包初始化。
    - `gateway.py`：对外网关接口，代理调用下游用户/订单服务。

## 三、运行方式

1. 安装依赖（需在仓库根目录）：

   ```bash
   pip install -r requirements.txt
   ```

2. 启动网关服务：

   ```bash
   uvicorn integration_gateway_service.app.main:app --reload
   ```

3. 访问文档页面：

   - 本地默认地址：`http://127.0.0.1:8000/docs`

## 四、配置说明

- 配置由 `app/config.py` 中的 `Settings` 管理，支持以下环境变量（带前缀 `GATEWAY_`）：
  - `GATEWAY_BACKEND_SERVICE_BASE_URL`：下游 HTTP 后端服务基础地址，默认 `http://localhost:9000`；
  - `GATEWAY_RBAC_JWT_SECRET_KEY`：用于验证 RBAC 服务签发的 JWT 的密钥；
  - `GATEWAY_RBAC_JWT_ALGORITHM`：JWT 算法，默认 `HS256`。

示例 `.env` 片段：

```env
GATEWAY_BACKEND_SERVICE_BASE_URL=http://localhost:9000
GATEWAY_RBAC_JWT_SECRET_KEY=please-change-me
GATEWAY_RBAC_JWT_ALGORITHM=HS256
```

## 五、与 RBAC 服务的协作方式（规划）

- 网关中的接口通过 `dependencies.get_current_user` 从 Bearer Token 中解析当前用户信息；
- 期望该 Token 由 `rbac_auth_service` 签发，使用相同的 `SECRET_KEY` 与算法；
- 未来可以拓展：
  - 从用户 payload 中读取角色/权限，并在网关层做简单的接口级授权控制；
  - 将关键调用（例如下单、敏感信息查询）的审计日志投递到独立的日志/审计服务。

## 六、后续扩展建议

- 按需将 `03.项目实战/08_系统对接_调用Java服务API` 中的更多示例接口迁移为网关路由（不再局限于 Java，可对接任意 HTTP 服务）；
- 在 `client_backend_service.py` 中增加更多领域相关方法（例如商品查询、订单列表等）；
- 引入统一错误码与追踪 ID，配合日志/监控模块实现完整的调用链追踪。

