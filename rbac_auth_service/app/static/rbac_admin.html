<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>RBAC ç®¡ç†æ§åˆ¶å°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg-app: #f1f5f9;
            --bg-panel: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --radius: 8px;
            --shadow-sm: 0 1px 2px 0 rgb(15 23 42 / 0.08);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
            background: radial-gradient(circle at top left, #eef2ff, #e2e8f0);
            min-height: 100vh;
            color: var(--text-main);
        }

        .app-shell {
            max-width: 1200px;
            margin: 24px auto;
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 20px;
        }

        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .header-title {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-title span.badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 999px;
            background-color: rgba(79, 70, 229, 0.08);
            color: #4f46e5;
        }

        .header-status {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            padding: 16px 14px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(148, 163, 184, 0.3);
            backdrop-filter: blur(10px);
            height: fit-content;
        }

        .sidebar-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin: 4px 0 8px;
            padding-left: 4px;
        }

        .nav-item {
            width: 100%;
            text-align: left;
            border: none;
            background: transparent;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-main);
            cursor: pointer;
            margin-bottom: 4px;
        }

        .nav-item span.icon {
            font-size: 1rem;
        }

        .nav-item.active,
        .nav-item:hover {
            background-color: rgba(79, 70, 229, 0.08);
            color: #1e293b;
        }

        .main-panel {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 16px;
            padding: 18px 20px 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(148, 163, 184, 0.35);
            backdrop-filter: blur(10px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .section-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin: 10px 0 8px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .form-input {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .btn-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .btn {
            border-radius: 999px;
            border: none;
            padding: 6px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #111827;
        }

        .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .btn-ghost {
            background-color: transparent;
            color: var(--text-muted);
        }

        .btn-ghost:hover {
            background-color: rgba(148, 163, 184, 0.15);
        }

        .help-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .output-card {
            margin-top: 12px;
            padding: 10px;
            border-radius: 8px;
            background-color: #0f172a;
            color: #e5e7eb;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.8rem;
            max-height: 360px;
            overflow: auto;
            white-space: pre-wrap;
        }

        .output-card .placeholder {
            color: #6b7280;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            background-color: #f1f5f9;
            font-size: 0.75rem;
            color: #64748b;
        }

        .tag-ok {
            color: #16a34a;
        }

        .tag-error {
            color: #b91c1c;
        }

        .matrix-wrapper {
            margin-top: 8px;
            overflow-x: auto;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid var(--border);
            padding: 4px 6px;
            text-align: center;
        }

        .matrix-table th.role-col {
            text-align: left;
            white-space: nowrap;
            background-color: #f1f5f9;
        }

        .matrix-table th.perm-col {
            white-space: nowrap;
        }

        .matrix-table td.role-cell {
            text-align: left;
            white-space: nowrap;
        }

        .matrix-table td.save-cell {
            white-space: nowrap;
        }

        @media (max-width: 900px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .main-panel {
                order: 1;
            }
        }
    </style>
</head>
<body>
<div class="app-shell">
    <header class="header">
        <div class="header-title">
            <span>ğŸ” RBAC ç®¡ç†æ§åˆ¶å°</span>
            <span class="badge">FastAPI Demo</span>
        </div>
        <div class="header-status">
            å½“å‰ç™»å½•ï¼š<span id="status-user">æœªç™»å½•</span>
            <span id="status-role" class="pill" style="margin-left: 4px; display: none;"></span>
            <span id="mock-indicator" class="pill tag-ok" style="margin-left: 4px;">æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼</span>
            <button id="toggle-mode-btn" class="btn btn-ghost" type="button" style="margin-left: 4px;">
                åˆ‡æ¢åˆ°ç›´è¿åç«¯
            </button>
        </div>
    </header>

    <aside class="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-section-title">åŸºç¡€</div>
            <button class="nav-item active" data-section="auth">
                <span class="icon">ğŸ§©</span>
                <span>è®¤è¯ä¸ä¼šè¯</span>
            </button>
            <button class="nav-item" data-section="me">
                <span class="icon">ğŸ‘¤</span>
                <span>å½“å‰ç”¨æˆ·ä¿¡æ¯</span>
            </button>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">RBAC ç®¡ç†</div>
            <button class="nav-item" data-section="rbac">
                <span class="icon">ğŸ§±</span>
                <span>è§’è‰²ä¸æƒé™</span>
            </button>
            <button class="nav-item" data-section="users">
                <span class="icon">ğŸ‘¥</span>
                <span>ç”¨æˆ·ç®¡ç†ï¼ˆè¶…ç®¡ï¼‰</span>
            </button>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">ç¤ºä¾‹èµ„æº</div>
            <button class="nav-item" data-section="resources">
                <span class="icon">âœ…</span>
                <span>Todos / Projects / Tasks</span>
            </button>
        </div>
    </aside>

    <main class="main-panel">
        <!-- è®¤è¯ä¸ä¼šè¯ -->
        <section id="section-auth">
            <div class="section-header">
                <div>
                    <div class="section-title">è®¤è¯ä¸ä¼šè¯</div>
                    <div class="section-subtitle">é€šè¿‡ /auth/login å’Œ /auth/logout ä½“éªŒæ•´å¥— JWT ç™»å½•æµç¨‹ã€‚</div>
                </div>
                <div class="pill">
                    é»˜è®¤è´¦å·ï¼š<code>admin / admin123</code>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-field">
                    <label class="form-label" for="login-username">ç”¨æˆ·å</label>
                    <input id="login-username" class="form-input" type="text" value="admin" autocomplete="username">
                </div>
                <div class="form-field">
                    <label class="form-label" for="login-password">å¯†ç </label>
                    <input id="login-password" class="form-input" type="password" value="admin123" autocomplete="current-password">
                </div>
            </div>
            <div class="btn-row">
                <button id="btn-login" class="btn btn-primary">ğŸ”‘ ç™»å½•</button>
                <button id="btn-logout" class="btn btn-secondary">ğŸšª ç™»å‡º</button>
                <button id="btn-me-quick" class="btn btn-ghost">ğŸ‘€ å¿«é€ŸæŸ¥çœ‹ /auth/me</button>
                <button id="btn-quick-admin" class="btn btn-ghost">âš¡ ä¸€é”® admin</button>
                <button id="btn-quick-alice" class="btn btn-ghost">âš¡ ä¸€é”® alice</button>
            </div>
            <p class="help-text">
                æç¤ºï¼šåç«¯ç™»å½•æ¥å£è·¯å¾„ä¸º <code>/auth/login</code>ï¼Œä½¿ç”¨è¡¨å• <code>username/password</code>ã€‚
                å®Œæˆç™»å½•åä¼šåœ¨å‰ç«¯å†…å­˜ä¿å­˜ access tokenã€‚
            </p>

            <div id="auth-output" class="output-card">
                <span class="placeholder">è¿™é‡Œä¼šæ˜¾ç¤ºç™»å½• / ç™»å‡ºä»¥åŠ /auth/me çš„å“åº”ç»“æœã€‚</span>
            </div>
        </section>

        <!-- å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
        <section id="section-me" style="display: none;">
            <div class="section-header">
                <div>
                    <div class="section-title">å½“å‰ç”¨æˆ·ä¿¡æ¯</div>
                    <div class="section-subtitle">è°ƒç”¨ <code>/auth/me</code> æŸ¥çœ‹ç»‘å®šåœ¨ JWT ä¸Šçš„ç”¨æˆ·ä¿¡æ¯ä¸è§’è‰²ã€‚</div>
                </div>
            </div>
            <div class="btn-row">
                <button id="btn-me" class="btn btn-primary">ğŸ‘¤ è·å– /auth/me</button>
            </div>
            <p class="help-text">
                éœ€è¦å…ˆå®Œæˆç™»å½•ï¼›å¦‚æœè¿”å› 401ï¼Œåˆ™è¯´æ˜ Token æ— æ•ˆæˆ–å·²è¿‡æœŸã€‚
            </p>
            <div id="me-output" class="output-card">
                <span class="placeholder">ç‚¹å‡»ã€Œè·å– /auth/meã€åï¼Œåœ¨è¿™é‡ŒæŸ¥çœ‹ç”¨æˆ· IDã€ç”¨æˆ·åã€æ˜¯å¦è¶…ç®¡ä»¥åŠç»‘å®šçš„è§’è‰²ã€‚</span>
            </div>
        </section>

        <!-- è§’è‰²ä¸æƒé™ -->
        <section id="section-rbac" style="display: none;">
            <div class="section-header">
                <div>
                    <div class="section-title">è§’è‰²ä¸æƒé™ç®¡ç†</div>
                    <div class="section-subtitle">é€šè¿‡ /rbac/roles ä¸ /rbac/permissions äº†è§£å½“å‰ç³»ç»Ÿå†…çš„ RBAC é…ç½®ã€‚</div>
                </div>
                <span class="pill tag-ok">éœ€è¦è¶…ç®¡æƒé™</span>
            </div>
            <div class="form-grid">
                <div class="form-field">
                    <label class="form-label" for="create-role-name">æ–°è§’è‰²åç§°</label>
                    <input id="create-role-name" class="form-input" type="text" placeholder="ä¾‹å¦‚ï¼šteacher">
                </div>
                <div class="form-field">
                    <label class="form-label" for="create-role-desc">è§’è‰²æè¿°</label>
                    <input id="create-role-desc" class="form-input" type="text" placeholder="ç”¨äºè¯´æ˜è§’è‰²ç”¨é€”">
                </div>
            </div>
            <div class="btn-row">
                <button id="btn-create-role" class="btn btn-secondary">â• åˆ›å»ºè§’è‰²</button>
            </div>
            <div class="form-grid" style="margin-top: 12px;">
                <div class="form-field">
                    <label class="form-label" for="create-perm-code">æ–°æƒé™ code</label>
                    <input id="create-perm-code" class="form-input" type="text" placeholder="ä¾‹å¦‚ï¼šcourses:read">
                </div>
                <div class="form-field">
                    <label class="form-label" for="create-perm-name">æƒé™åç§°</label>
                    <input id="create-perm-name" class="form-input" type="text" placeholder="ç®€è¦è¯´æ˜æƒé™ç”¨é€”">
                </div>
                <div class="form-field">
                    <label class="form-label" for="create-perm-desc">æƒé™æè¿°ï¼ˆå¯é€‰ï¼‰</label>
                    <input id="create-perm-desc" class="form-input" type="text" placeholder="æ›´è¯¦ç»†çš„è¯´æ˜ï¼ˆå¯ç©ºï¼‰">
                </div>
            </div>
            <div class="btn-row">
                <button id="btn-create-perm" class="btn btn-secondary">â• åˆ›å»ºæƒé™</button>
            </div>
            <div class="btn-row">
                <button id="btn-list-roles" class="btn btn-primary">ğŸ“œ åˆ—å‡ºè§’è‰²åˆ—è¡¨</button>
                <button id="btn-list-perms" class="btn btn-secondary">ğŸ§¾ åˆ—å‡ºæƒé™åˆ—è¡¨</button>
            </div>
            <p class="help-text">
                é»˜è®¤ admin è´¦å·å…·å¤‡è¶…ç®¡æƒé™ï¼›å¦‚æœä½¿ç”¨æ™®é€šç”¨æˆ·ç™»å½•ï¼Œè¯·æ±‚ä¼šè¿”å› 403 Forbiddenã€‚
            </p>
            <div id="rbac-matrix" class="help-text" style="margin-top: 8px;">
                å½“å‰å°šæœªåŠ è½½è§’è‰²æ•°æ®ï¼Œç‚¹å‡»ä¸Šæ–¹ã€Œåˆ—å‡ºè§’è‰²åˆ—è¡¨ã€åï¼Œè¿™é‡Œä¼šä»¥çŸ©é˜µå½¢å¼å±•ç¤ºã€Œè§’è‰² â†’ æƒé™ç ã€ã€‚
            </div>
            <div id="rbac-output" class="output-card">
                <span class="placeholder">ç‚¹å‡»æŒ‰é’®åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºè§’è‰²åˆ—è¡¨æˆ–æƒé™åˆ—è¡¨å®Œæ•´ JSON æ•°æ®ã€‚</span>
            </div>
        </section>

        <!-- ç”¨æˆ·ç®¡ç† -->
        <section id="section-users" style="display: none;">
            <div class="section-header">
                <div>
                    <div class="section-title">ç”¨æˆ·ç®¡ç†ï¼ˆåªè¯» Demoï¼‰</div>
                    <div class="section-subtitle">é€šè¿‡ /users åˆ—å‡ºç”¨æˆ·ï¼Œè§‚å¯Ÿè§’è‰²åˆ†é…æ•ˆæœã€‚</div>
                </div>
                <span class="pill tag-ok">ä»…é™è¶…ç®¡è®¿é—®</span>
            </div>
            <div class="btn-row">
                <button id="btn-list-users" class="btn btn-primary">ğŸ‘¥ åˆ—å‡ºç”¨æˆ·åˆ—è¡¨</button>
            </div>
            <p class="help-text">
                è¿™é‡Œåšçš„æ˜¯ã€Œåªè¯»ã€æ¼”ç¤ºï¼šå®é™… API è¿˜æ”¯æŒåˆ›å»ºç”¨æˆ·ã€æ›´æ–°çŠ¶æ€ä»¥åŠä¸ºç”¨æˆ·åˆ†é…è§’è‰²ï¼Œ
                ä½ å¯ä»¥åœ¨ç†Ÿæ‚‰æµç¨‹åå†é€šè¿‡ Postman æˆ–ä»£ç è°ƒç”¨è¿™äº›å†™å…¥æ¥å£ã€‚
            </p>
            <div id="users-output" class="output-card">
                <span class="placeholder">ç‚¹å‡»ã€Œåˆ—å‡ºç”¨æˆ·åˆ—è¡¨ã€åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·åŠå…¶è§’è‰²ä¿¡æ¯ã€‚</span>
            </div>
        </section>

        <!-- ç¤ºä¾‹èµ„æº -->
        <section id="section-resources" style="display: none;">
            <div class="section-header">
                <div>
                    <div class="section-title">ç¤ºä¾‹ä¸šåŠ¡èµ„æºï¼ˆTodos / Projects / Tasksï¼‰</div>
                    <div class="section-subtitle">ä½“éªŒã€Œç™»å½• + RBAC æƒé™æ§åˆ¶ã€ä¸‹çš„ä¸šåŠ¡æ¥å£è®¿é—®ã€‚</div>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-field">
                    <label class="form-label" for="project-id-input">é¡¹ç›® IDï¼ˆç”¨äº Tasks ç¤ºä¾‹ï¼‰</label>
                    <input id="project-id-input" class="form-input" type="number" placeholder="ä¾‹å¦‚ï¼š1">
                </div>
            </div>
            <div class="btn-row">
                <button id="btn-list-todos" class="btn btn-primary">âœ… GET /todos</button>
                <button id="btn-list-projects" class="btn btn-secondary">ğŸ“‚ GET /projects</button>
                <button id="btn-list-tasks" class="btn btn-secondary">ğŸ§© GET /projects/{id}/tasks</button>
            </div>
            <p class="help-text">
                è¿™äº›æ¥å£éƒ½é€šè¿‡ <code>require_permissions</code> è¿›è¡Œä¿æŠ¤ï¼šæ™®é€šç”¨æˆ·ä¸è¶…ç®¡çš„æƒé™é›†ä¸åŒï¼Œè¿”å› 403 æ—¶è¯·ç•™æ„åç«¯é”™è¯¯ä¿¡æ¯ä¸­çš„æç¤ºã€‚
            </p>
            <div id="resources-output" class="output-card">
                <span class="placeholder">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå¯¹åº”ä¸šåŠ¡æ¥å£è¿”å›çš„æ•°æ®æˆ–é”™è¯¯ä¿¡æ¯ã€‚</span>
            </div>
        </section>
    </main>
</div>

<script>
    // ========== å…¨å±€çŠ¶æ€ ==========
    // é»˜è®¤ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼ï¼Œä¾¿äºåœ¨æœªå¯åŠ¨åç«¯æœåŠ¡æ—¶ä¹Ÿèƒ½äº¤äº’ä½“éªŒã€‚
    let MOCK_MODE = true;
    let accessToken = null;

    // é»˜è®¤åç«¯åŸºåœ°å€ï¼šå‡å®š uvicorn åœ¨æœ¬æœº 8000 ç«¯å£è¿è¡Œ
    const API_BASE = "";

    // ========== æ¨¡æ‹Ÿæ•°æ®ï¼ˆç»“æ„å°½é‡ä¸åç«¯æ¨¡å‹ä¸€è‡´ï¼‰ ==========
    const mockPermissionsData = [
        { id: 1, code: "todos:read", name: "è¯»å– TODO", description: "æŸ¥çœ‹ TODO åˆ—è¡¨" },
        { id: 2, code: "todos:write", name: "åˆ›å»º/æ›´æ–° TODO", description: "åˆ›å»ºæˆ–ä¿®æ”¹ TODO" },
        { id: 3, code: "todos:delete", name: "åˆ é™¤ TODO", description: "åˆ é™¤ TODO" },
        { id: 4, code: "projects:read", name: "è¯»å–é¡¹ç›®", description: "æŸ¥çœ‹é¡¹ç›®åˆ—è¡¨" },
        { id: 5, code: "projects:write", name: "åˆ›å»º/æ›´æ–°é¡¹ç›®", description: "åˆ›å»ºæˆ–ä¿®æ”¹é¡¹ç›®" },
        { id: 6, code: "projects:delete", name: "åˆ é™¤é¡¹ç›®", description: "åˆ é™¤é¡¹ç›®" },
        { id: 7, code: "tasks:read", name: "è¯»å–ä»»åŠ¡", description: "æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨" },
        { id: 8, code: "tasks:write", name: "åˆ›å»º/æ›´æ–°ä»»åŠ¡", description: "åˆ›å»ºæˆ–ä¿®æ”¹ä»»åŠ¡" },
        { id: 9, code: "tasks:delete", name: "åˆ é™¤ä»»åŠ¡", description: "åˆ é™¤ä»»åŠ¡" },
    ];
    let nextMockPermId = 10;

    const mockRolesData = [
        {
            id: 1,
            name: "admin",
            description: "ç®¡ç†å‘˜",
            permissionCodes: mockPermissionsData.map(p => p.code),
        },
        {
            id: 2,
            name: "user",
            description: "æ™®é€šç”¨æˆ·",
            permissionCodes: [
                "todos:read",
                "todos:write",
                "projects:read",
                "projects:write",
                "tasks:read",
                "tasks:write",
            ],
        },
    ];
    let nextMockRoleId = 3;

    const mockUsersData = [
        {
            id: 1,
            username: "admin",
            is_active: true,
            is_superuser: true,
            roleNames: ["admin"],
        },
        {
            id: 2,
            username: "alice",
            is_active: true,
            is_superuser: false,
            roleNames: ["user"],
        },
    ];

    // ç®€å•çš„ä¸šåŠ¡æ•°æ®ï¼šTodo / Project / Task
    const mockTodos = [
        { id: 1, title: "ç¤ºä¾‹ TODOï¼ˆadminï¼‰", completed: false, owner_id: 1 },
        { id: 2, title: "ç¤ºä¾‹ TODOï¼ˆaliceï¼‰", completed: true, owner_id: 2 },
    ];
    const mockProjects = [
        { id: 1, name: "demo-project-admin", description: "ç®¡ç†å‘˜çš„ç¤ºä¾‹é¡¹ç›®", status: "active", owner_id: 1 },
        { id: 2, name: "demo-project-alice", description: "alice çš„ç¤ºä¾‹é¡¹ç›®", status: "active", owner_id: 2 },
    ];
    const mockTasks = [
        { id: 1, title: "admin-task-1", description: "ç®¡ç†å‘˜ä»»åŠ¡", status: "todo", project_id: 1 },
        { id: 2, title: "alice-task-1", description: "alice çš„ä»»åŠ¡", status: "todo", project_id: 2 },
    ];

    let currentMockUser = null;

    function mockFindPermissionByCode(code) {
        return mockPermissionsData.find(p => p.code === code) || null;
    }

    function mockFindPermissionById(id) {
        return mockPermissionsData.find(p => p.id === id) || null;
    }

    function mockFindRoleById(id) {
        return mockRolesData.find(r => r.id === id) || null;
    }

    function mockGetUserRoles(user) {
        if (!user) return [];
        return mockRolesData.filter(r => user.roleNames && user.roleNames.includes(r.name));
    }

    function mockGetUserPermissions(user) {
        if (!user) return new Set();
        if (user.is_superuser) {
            return new Set(mockPermissionsData.map(p => p.code));
        }
        const perms = new Set();
        const roles = mockGetUserRoles(user);
        roles.forEach(role => {
            role.permissionCodes.forEach(code => perms.add(code));
        });
        return perms;
    }

    function mockUserHasPermission(user, code) {
        const perms = mockGetUserPermissions(user);
        return perms.has(code);
    }

    function makeApiResponse(code, message, data) {
        return { code, message, data };
    }

    function mockNowIso() {
        return new Date().toISOString();
    }

    function mockUserOut(user) {
        const roles = mockGetUserRoles(user).map(r => ({ id: r.id, name: r.name }));
        return {
            id: user.id,
            username: user.username,
            is_active: user.is_active,
            is_superuser: user.is_superuser,
            roles,
            created_at: mockNowIso(),
            updated_at: mockNowIso(),
        };
    }

    function mockRoleOut(role) {
        const perms = role.permissionCodes
            .map(code => mockFindPermissionByCode(code))
            .filter(Boolean)
            .map(p => ({ id: p.id, code: p.code, name: p.name }));
        return { id: role.id, name: role.name, description: role.description, permissions: perms };
    }

    function mockPermissionOut(p) {
        return { id: p.id, code: p.code, name: p.name, description: p.description || null };
    }

    async function mockApiRequest(path, options = {}) {
        const method = (options.method || "GET").toUpperCase();

        // è§£æç™»å½•è¡¨å•
        if (path === "/auth/login" && method === "POST") {
            let username = "";
            let password = "";
            if (options.body instanceof URLSearchParams) {
                username = options.body.get("username") || "";
                password = options.body.get("password") || "";
            }
            const user = mockUsersData.find(u => u.username === username);
            if (!user) {
                return {
                    status: 400,
                    data: makeApiResponse("BAD_REQUEST", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            if (
                (username === "admin" && password !== "admin123") ||
                (username === "alice" && password !== "alice123")
            ) {
                return {
                    status: 400,
                    data: makeApiResponse("BAD_REQUEST", "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            currentMockUser = { ...user };
            const token = {
                access_token: `mock-${user.username}-token`,
                token_type: "bearer",
            };
            return {
                status: 200,
                data: makeApiResponse("OK", "ç™»å½•æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", token),
            };
        }

        if (path === "/auth/me" && method === "GET") {
            if (!currentMockUser) {
                return {
                    status: 401,
                    data: makeApiResponse("UNAUTHORIZED", "æœªç™»å½•ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            return {
                status: 200,
                data: makeApiResponse("OK", "è·å–æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", mockUserOut(currentMockUser)),
            };
        }

        if (path === "/auth/logout" && method === "POST") {
            currentMockUser = null;
            return {
                status: 200,
                data: makeApiResponse("OK", "ç™»å‡ºæˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", { username: "mock" }),
            };
        }

        // éœ€è¦è¶…ç®¡çš„æ¥å£ï¼šadmin æ‰èƒ½è®¿é—®
        function assertSuperuser() {
            if (!currentMockUser) {
                return {
                    status: 401,
                    data: makeApiResponse("UNAUTHORIZED", "æœªç™»å½•ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            if (!currentMockUser.is_superuser) {
                return {
                    status: 403,
                    data: makeApiResponse("FORBIDDEN", "éœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            return null;
        }

        if (path === "/rbac/roles" && method === "GET") {
            const err = assertSuperuser();
            if (err) return err;
            const roles = mockRolesData.map(mockRoleOut);
            return {
                status: 200,
                data: makeApiResponse("OK", "è·å–è§’è‰²åˆ—è¡¨æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", roles),
            };
        }

        if (path === "/rbac/permissions" && method === "GET") {
            const err = assertSuperuser();
            if (err) return err;
            const perms = mockPermissionsData.map(mockPermissionOut);
            return {
                status: 200,
                data: makeApiResponse("OK", "è·å–æƒé™åˆ—è¡¨æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", perms),
            };
        }

        if (path === "/rbac/roles" && method === "POST") {
            const err = assertSuperuser();
            if (err) return err;
            let payload = {};
            try {
                payload = JSON.parse(options.body || "{}");
            } catch {
                payload = {};
            }
            const name = (payload.name || "").trim();
            const description = payload.description || null;
            if (!name) {
                return {
                    status: 400,
                    data: makeApiResponse("BAD_REQUEST", "è§’è‰²åç§°ä¸èƒ½ä¸ºç©ºï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            if (mockRolesData.some(r => r.name === name)) {
                return {
                    status: 400,
                    data: makeApiResponse("BAD_REQUEST", "è§’è‰²åå·²å­˜åœ¨ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            const role = {
                id: nextMockRoleId++,
                name,
                description,
                permissionCodes: [],
            };
            mockRolesData.push(role);
            return {
                status: 201,
                data: makeApiResponse("OK", "åˆ›å»ºè§’è‰²æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", mockRoleOut(role)),
            };
        }

        if (path === "/rbac/permissions" && method === "POST") {
            const err = assertSuperuser();
            if (err) return err;
            let payload = {};
            try {
                payload = JSON.parse(options.body || "{}");
            } catch {
                payload = {};
            }
            const code = (payload.code || "").trim();
            const name = (payload.name || "").trim();
            const description = payload.description || null;
            if (!code || !name) {
                return {
                    status: 400,
                    data: makeApiResponse("BAD_REQUEST", "æƒé™ code å’Œåç§°å‡ä¸èƒ½ä¸ºç©ºï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            if (mockPermissionsData.some(p => p.code === code)) {
                return {
                    status: 400,
                    data: makeApiResponse("BAD_REQUEST", "æƒé™ code å·²å­˜åœ¨ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            const perm = {
                id: nextMockPermId++,
                code,
                name,
                description,
            };
            mockPermissionsData.push(perm);
            return {
                status: 201,
                data: makeApiResponse("OK", "åˆ›å»ºæƒé™æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", mockPermissionOut(perm)),
            };
        }

        if (path.startsWith("/rbac/roles/") && path.endsWith("/permissions") && method === "POST") {
            const err = assertSuperuser();
            if (err) return err;
            const parts = path.split("/");
            const roleId = parseInt(parts[3], 10);
            const role = mockFindRoleById(roleId);
            if (!role) {
                return {
                    status: 404,
                    data: makeApiResponse("NOT_FOUND", "è§’è‰²ä¸å­˜åœ¨ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            let payload = {};
            try {
                payload = JSON.parse(options.body || "{}");
            } catch {
                payload = {};
            }
            const ids = Array.isArray(payload.permission_ids) ? payload.permission_ids : [];
            const codes = [];
            for (const pid of ids) {
                const perm = mockFindPermissionById(pid);
                if (perm) {
                    codes.push(perm.code);
                }
            }
            role.permissionCodes = codes;
            return {
                status: 200,
                data: makeApiResponse("OK", "åˆ†é…æƒé™æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", mockRoleOut(role)),
            };
        }

        // ç”¨æˆ·åˆ—è¡¨ï¼ˆä»…è¶…ç®¡ï¼‰
        if (path === "/users/" && method === "GET") {
            const err = assertSuperuser();
            if (err) return err;
            const users = mockUsersData.map(mockUserOut);
            return {
                status: 200,
                data: makeApiResponse("OK", "è·å–ç”¨æˆ·åˆ—è¡¨æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", users),
            };
        }

        // TODO / Projects / Tasks ç¤ºä¾‹èµ„æº
        if (path === "/todos/" && method === "GET") {
            if (!currentMockUser) {
                return {
                    status: 401,
                    data: makeApiResponse("UNAUTHORIZED", "æœªç™»å½•ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            if (!mockUserHasPermission(currentMockUser, "todos:read")) {
                return {
                    status: 403,
                    data: makeApiResponse("FORBIDDEN", "ç¼ºå°‘ todos:read æƒé™ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            const todos = mockTodos.filter(t => t.owner_id === currentMockUser.id);
            return {
                status: 200,
                data: makeApiResponse("OK", "è·å– TODO åˆ—è¡¨æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", todos),
            };
        }

        if (path === "/projects/" && method === "GET") {
            if (!currentMockUser) {
                return {
                    status: 401,
                    data: makeApiResponse("UNAUTHORIZED", "æœªç™»å½•ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            if (!mockUserHasPermission(currentMockUser, "projects:read")) {
                return {
                    status: 403,
                    data: makeApiResponse("FORBIDDEN", "ç¼ºå°‘ projects:read æƒé™ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            const projects = mockProjects.filter(p => p.owner_id === currentMockUser.id).map(p => ({
                ...p,
                created_at: mockNowIso(),
                updated_at: mockNowIso(),
            }));
            return {
                status: 200,
                data: makeApiResponse("OK", "è·å–é¡¹ç›®åˆ—è¡¨æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", projects),
            };
        }

        if (path.startsWith("/projects/") && path.endsWith("/tasks/") && method === "GET") {
            if (!currentMockUser) {
                return {
                    status: 401,
                    data: makeApiResponse("UNAUTHORIZED", "æœªç™»å½•ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            if (!mockUserHasPermission(currentMockUser, "tasks:read")) {
                return {
                    status: 403,
                    data: makeApiResponse("FORBIDDEN", "ç¼ºå°‘ tasks:read æƒé™ï¼ˆæ¨¡æ‹Ÿï¼‰", null),
                };
            }
            const parts = path.split("/");
            const projectId = parseInt(parts[2], 10);
            const tasks = mockTasks
                .filter(t => t.project_id === projectId)
                .map(t => ({
                    ...t,
                    created_at: mockNowIso(),
                    updated_at: mockNowIso(),
                }));
            return {
                status: 200,
                data: makeApiResponse("OK", "è·å–ä»»åŠ¡åˆ—è¡¨æˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰", tasks),
            };
        }

        // é»˜è®¤è¿”å› 404ï¼ˆæ¨¡æ‹Ÿï¼‰
        return {
            status: 404,
            data: makeApiResponse("NOT_FOUND", `æœªåœ¨æ¨¡æ‹Ÿæ•°æ®ä¸­å®ç°çš„æ¥å£: ${path}`, null),
        };
    }

    function setOutput(elementId, payload, isError = false) {
        const el = document.getElementById(elementId);
        if (!el) return;
        if (!payload) {
            el.innerHTML = '<span class="placeholder">æ— å†…å®¹</span>';
            return;
        }
        if (typeof payload === "string") {
            el.textContent = payload;
        } else {
            el.textContent = JSON.stringify(payload, null, 2);
        }
        if (isError) {
            el.style.border = "1px solid rgba(248, 113, 113, 0.7)";
        } else {
            el.style.border = "none";
        }
    }

    function updateStatusBar(user) {
        const userEl = document.getElementById("status-user");
        const roleEl = document.getElementById("status-role");
        const mockIndicator = document.getElementById("mock-indicator");
        const toggleBtn = document.getElementById("toggle-mode-btn");
        if (!user || !user.username) {
            userEl.textContent = "æœªç™»å½•";
            roleEl.style.display = "none";
        } else {
            userEl.textContent = user.username;
            let roleText = user.is_superuser ? "è¶…çº§ç®¡ç†å‘˜" : "æ™®é€šç”¨æˆ·";
            if (user.roles && user.roles.length > 0) {
                const names = user.roles.map(r => r.name).join(", ");
                roleText += " Â· è§’è‰²: " + names;
            }
            roleEl.textContent = roleText;
            roleEl.style.display = "inline-flex";
        }
        if (mockIndicator) {
            mockIndicator.textContent = MOCK_MODE ? "æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼" : "ç›´è¿åç«¯æ¨¡å¼";
        }
        if (toggleBtn) {
            toggleBtn.textContent = MOCK_MODE ? "åˆ‡æ¢åˆ°ç›´è¿åç«¯" : "åˆ‡æ¢åˆ°æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼";
        }
    }

    async function apiRequest(path, options = {}) {
        if (MOCK_MODE) {
            return mockApiRequest(path, options);
        }
        const headers = options.headers || {};
        if (accessToken) {
            headers["Authorization"] = "Bearer " + accessToken;
        }
        options.headers = headers;

        const resp = await fetch(API_BASE + path, options);
        let data = null;
        const text = await resp.text();
        try {
            data = text ? JSON.parse(text) : null;
        } catch {
            data = text || null;
        }
        return { status: resp.status, data };
    }

    // ========== å¯¼èˆªåˆ‡æ¢ ==========
    const sections = ["auth", "me", "rbac", "users", "resources"];
    function switchSection(name) {
        sections.forEach(s => {
            const secEl = document.getElementById(`section-${s}`);
            if (secEl) {
                secEl.style.display = s === name ? "block" : "none";
            }
        });
        document.querySelectorAll(".nav-item").forEach(btn => {
            btn.classList.toggle("active", btn.dataset.section === name);
        });
    }

    document.querySelectorAll(".nav-item").forEach(btn => {
        btn.addEventListener("click", () => {
            const target = btn.dataset.section;
            switchSection(target);
        });
    });

    // ========== ç™»å½• / ç™»å‡º / å½“å‰ç”¨æˆ· ==========
    document.getElementById("btn-login").addEventListener("click", async () => {
        const username = document.getElementById("login-username").value.trim();
        const password = document.getElementById("login-password").value;
        if (!username || !password) {
            setOutput("auth-output", "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º", true);
            return;
        }
        const body = new URLSearchParams();
        body.append("username", username);
        body.append("password", password);

        try {
            const { status, data } = await apiRequest("/auth/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body,
            });
            if (status === 200 && data && data.data && data.data.access_token) {
                accessToken = data.data.access_token;
                setOutput("auth-output", data);
                // ç™»å½•æˆåŠŸåè‡ªåŠ¨è°ƒç”¨ /auth/me æ›´æ–°çŠ¶æ€æ 
                await fetchMe(true);
            } else {
                setOutput("auth-output", data || `ç™»å½•å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç ï¼š${status}`, true);
            }
        } catch (err) {
            setOutput("auth-output", `è¯·æ±‚å‡ºé”™ï¼š${err}`, true);
        }
    });

    // ä¾¿æ·åˆ‡æ¢è´¦å·ï¼šadmin / alice
    document.getElementById("btn-quick-admin").addEventListener("click", () => {
        document.getElementById("login-username").value = "admin";
        document.getElementById("login-password").value = "admin123";
    });

    document.getElementById("btn-quick-alice").addEventListener("click", () => {
        document.getElementById("login-username").value = "alice";
        document.getElementById("login-password").value = "alice123";
    });

    document.getElementById("btn-logout").addEventListener("click", async () => {
        if (!accessToken) {
            setOutput("auth-output", "å½“å‰å°šæœªç™»å½•ï¼Œæ— éœ€ç™»å‡ºã€‚");
            return;
        }
        try {
            const { status, data } = await apiRequest("/auth/logout", {
                method: "POST",
            });
            accessToken = null;
            updateStatusBar(null);
            setOutput("auth-output", data || `ç™»å‡ºå®Œæˆï¼ŒHTTP çŠ¶æ€ç ï¼š${status}`);
        } catch (err) {
            setOutput("auth-output", `è¯·æ±‚å‡ºé”™ï¼š${err}`, true);
        }
    });

    async function fetchMe(updateAuthPanel = false) {
        try {
            const { status, data } = await apiRequest("/auth/me", {
                method: "GET",
            });
            if (status === 200 && data && data.data) {
                updateStatusBar(data.data);
            } else {
                updateStatusBar(null);
            }
            if (updateAuthPanel) {
                setOutput("auth-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`);
            }
            setOutput("me-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`, status !== 200);
        } catch (err) {
            setOutput("me-output", `è¯·æ±‚å‡ºé”™ï¼š${err}`, true);
        }
    }

    document.getElementById("btn-me-quick").addEventListener("click", () => {
        fetchMe(true);
    });
    document.getElementById("btn-me").addEventListener("click", () => {
        fetchMe(false);
    });

    // ========== è§’è‰²ä¸æƒé™ ==========
    function renderRolePermissionMatrix(roles, perms) {
        const matrixEl = document.getElementById("rbac-matrix");
        if (!matrixEl) return;

        if (!Array.isArray(roles) || roles.length === 0) {
            matrixEl.textContent = "å½“å‰ç³»ç»Ÿä¸­æ²¡æœ‰ä»»ä½•è§’è‰²ã€‚";
            return;
        }
        if (!Array.isArray(perms) || perms.length === 0) {
            matrixEl.textContent = "æ— æ³•ç”ŸæˆçŸ©é˜µè§†å›¾ï¼šå°šæœªè·å–åˆ°æƒé™åˆ—è¡¨ã€‚";
            return;
        }

        let html = '<div class="matrix-wrapper">';
        html += '<div style="font-size:0.8rem;margin-bottom:4px;">å‹¾é€‰åç‚¹å‡»å¯¹åº”è¡Œã€Œä¿å­˜ã€æŒ‰é’®ï¼Œå°†æ›´æ–°è¯¥è§’è‰²æ‹¥æœ‰çš„æƒé™ï¼ˆè°ƒç”¨ /rbac/roles/{id}/permissionsï¼‰ã€‚</div>';
        html += '<table class="matrix-table"><thead><tr>';
        html += '<th class="role-col">è§’è‰²</th>';
        for (const perm of perms) {
            html += `<th class="perm-col" title="${perm.code}">${perm.code}</th>`;
        }
        html += '<th>æ“ä½œ</th></tr></thead><tbody>';

        for (const role of roles) {
            const rolePermIds = new Set((role.permissions || []).map(p => p.id));
            html += '<tr>';
            html += `<td class="role-cell">${role.name}</td>`;
            for (const perm of perms) {
                const checked = rolePermIds.has(perm.id) ? 'checked' : '';
                html += `<td><input type="checkbox" data-role-id="${role.id}" data-perm-id="${perm.id}" ${checked}></td>`;
            }
            html += `<td class="save-cell"><button type="button" class="btn btn-secondary role-save-btn" data-role-id="${role.id}">ğŸ’¾ ä¿å­˜</button></td>`;
            html += '</tr>';
        }

        html += '</tbody></table></div>';
        matrixEl.innerHTML = html;
    }

    document.getElementById("btn-list-roles").addEventListener("click", async () => {
        try {
            const { status, data } = await apiRequest("/rbac/roles", { method: "GET" });
            setOutput("rbac-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`, status !== 200);

            const matrixEl = document.getElementById("rbac-matrix");
            if (!matrixEl) return;
            if (status !== 200 || !data || !Array.isArray(data.data)) {
                matrixEl.textContent = "æ— æ³•ç”ŸæˆçŸ©é˜µè§†å›¾ï¼šè¯·ç¡®è®¤å·²ä½¿ç”¨ admin ç™»å½•ä¸”æ¥å£è¿”å› 200ã€‚";
                return;
            }
            const roles = data.data;

            // åŒæ—¶è·å–æƒé™åˆ—è¡¨ï¼Œä¿è¯ä¸åç«¯å®šä¹‰å®Œå…¨ä¸€è‡´
            const permsResp = await apiRequest("/rbac/permissions", { method: "GET" });
            if (permsResp.status !== 200 || !permsResp.data || !Array.isArray(permsResp.data.data)) {
                matrixEl.textContent = "å·²è·å–è§’è‰²ï¼Œä½†æ‹‰å–æƒé™åˆ—è¡¨å¤±è´¥ï¼Œæ— æ³•ç”ŸæˆçŸ©é˜µè§†å›¾ã€‚";
                return;
            }
            const perms = permsResp.data.data;
            renderRolePermissionMatrix(roles, perms);
        } catch (err) {
            setOutput("rbac-output", `è¯·æ±‚å‡ºé”™ï¼š${err}`, true);
        }
    });

    document.getElementById("btn-list-perms").addEventListener("click", async () => {
        try {
            const { status, data } = await apiRequest("/rbac/permissions", { method: "GET" });
            setOutput("rbac-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`, status !== 200);
        } catch (err) {
            setOutput("rbac-output", `è¯·æ±‚å‡ºé”™ï¼š${err}`, true);
        }
    });

    // åˆ›å»ºè§’è‰²ä¸æƒé™
    document.getElementById("btn-create-role").addEventListener("click", async () => {
        const nameInput = document.getElementById("create-role-name");
        const descInput = document.getElementById("create-role-desc");
        const name = nameInput.value.trim();
        const description = descInput.value.trim() || null;
        if (!name) {
            setOutput("rbac-output", "è§’è‰²åç§°ä¸èƒ½ä¸ºç©ºã€‚", true);
            return;
        }
        try {
            const { status, data } = await apiRequest("/rbac/roles", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ name, description }),
            });
            setOutput("rbac-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`, status !== 201);
            if (status === 201) {
                nameInput.value = "";
                descInput.value = "";
                // åˆ›å»ºæˆåŠŸååˆ·æ–°è§’è‰²åˆ—è¡¨å’ŒçŸ©é˜µè§†å›¾
                document.getElementById("btn-list-roles").click();
            }
        } catch (err) {
            setOutput("rbac-output", `åˆ›å»ºè§’è‰²æ—¶å‡ºé”™ï¼š${err}`, true);
        }
    });

    document.getElementById("btn-create-perm").addEventListener("click", async () => {
        const codeInput = document.getElementById("create-perm-code");
        const nameInput = document.getElementById("create-perm-name");
        const descInput = document.getElementById("create-perm-desc");
        const code = codeInput.value.trim();
        const name = nameInput.value.trim();
        const description = descInput.value.trim() || null;
        if (!code || !name) {
            setOutput("rbac-output", "æƒé™ code å’Œåç§°å‡ä¸èƒ½ä¸ºç©ºã€‚", true);
            return;
        }
        try {
            const { status, data } = await apiRequest("/rbac/permissions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ code, name, description }),
            });
            setOutput("rbac-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`, status !== 201);
            if (status === 201) {
                codeInput.value = "";
                nameInput.value = "";
                descInput.value = "";
                // åˆ›å»ºæˆåŠŸååˆ·æ–°æƒé™åˆ—è¡¨å’ŒçŸ©é˜µè§†å›¾
                document.getElementById("btn-list-roles").click();
                document.getElementById("btn-list-perms").click();
            }
        } catch (err) {
            setOutput("rbac-output", `åˆ›å»ºæƒé™æ—¶å‡ºé”™ï¼š${err}`, true);
        }
    });

    // è§’è‰²-æƒé™çŸ©é˜µä¿å­˜äº‹ä»¶ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
    document.getElementById("rbac-matrix").addEventListener("click", async (event) => {
        const target = event.target;
        if (!target || !target.classList || !target.classList.contains("role-save-btn")) {
            return;
        }
        const roleId = target.dataset.roleId;
        if (!roleId) return;

        const row = target.closest("tr");
        if (!row) return;

        const checkboxes = row.querySelectorAll('input[type="checkbox"][data-perm-id]');
        const permissionIds = [];
        checkboxes.forEach(cb => {
            if (cb.checked) {
                const pid = parseInt(cb.dataset.permId, 10);
                if (!Number.isNaN(pid)) {
                    permissionIds.push(pid);
                }
            }
        });

        try {
            const { status, data } = await apiRequest(`/rbac/roles/${roleId}/permissions`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ permission_ids: permissionIds }),
            });
            setOutput("rbac-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`, status !== 200);
        } catch (err) {
            setOutput("rbac-output", `æ›´æ–°è§’è‰²æƒé™æ—¶å‡ºé”™ï¼š${err}`, true);
        }
    });

    // ========== ç”¨æˆ·ç®¡ç†ï¼ˆåªè¯»ï¼‰ ==========
    document.getElementById("btn-list-users").addEventListener("click", async () => {
        try {
            const { status, data } = await apiRequest("/users/", { method: "GET" });
            setOutput("users-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`, status !== 200);
        } catch (err) {
            setOutput("users-output", `è¯·æ±‚å‡ºé”™ï¼š${err}`, true);
        }
    });

    // ========== ç¤ºä¾‹ä¸šåŠ¡èµ„æº ==========
    document.getElementById("btn-list-todos").addEventListener("click", async () => {
        try {
            const { status, data } = await apiRequest("/todos/", { method: "GET" });
            setOutput("resources-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`, status !== 200);
        } catch (err) {
            setOutput("resources-output", `è¯·æ±‚å‡ºé”™ï¼š${err}`, true);
        }
    });

    document.getElementById("btn-list-projects").addEventListener("click", async () => {
        try {
            const { status, data } = await apiRequest("/projects/", { method: "GET" });
            setOutput("resources-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`, status !== 200);
        } catch (err) {
            setOutput("resources-output", `è¯·æ±‚å‡ºé”™ï¼š${err}`, true);
        }
    });

    document.getElementById("btn-list-tasks").addEventListener("click", async () => {
        const projectId = document.getElementById("project-id-input").value.trim();
        if (!projectId) {
            setOutput("resources-output", "è¯·å…ˆå¡«å†™é¡¹ç›® IDï¼Œä¾‹å¦‚ 1ã€‚", true);
            return;
        }
        try {
            const { status, data } = await apiRequest(`/projects/${projectId}/tasks/`, { method: "GET" });
            setOutput("resources-output", data || `HTTP çŠ¶æ€ç ï¼š${status}`, status !== 200);
        } catch (err) {
            setOutput("resources-output", `è¯·æ±‚å‡ºé”™ï¼š${err}`, true);
        }
    });

    // åˆ‡æ¢æ¨¡æ‹Ÿæ¨¡å¼ / ç›´è¿åç«¯æ¨¡å¼
    const toggleBtn = document.getElementById("toggle-mode-btn");
    if (toggleBtn) {
        toggleBtn.addEventListener("click", () => {
            MOCK_MODE = !MOCK_MODE;
            // åˆ‡æ¢æ¨¡å¼æ—¶æ¸…ç©ºå½“å‰ç™»å½•çŠ¶æ€ä¸è¾“å‡ºï¼Œé¿å…æ··æ·†
            accessToken = null;
            currentMockUser = null;
            updateStatusBar(null);
            setOutput("auth-output", "å·²åˆ‡æ¢æ¨¡å¼ï¼Œè¯·é‡æ–°ç™»å½•ã€‚");
            setOutput("me-output", null);
            setOutput("rbac-output", null);
            setOutput("users-output", null);
            setOutput("resources-output", null);
        });
    }

    // é»˜è®¤å±•ç¤ºè®¤è¯é¡µï¼Œå¹¶åˆ·æ–°çŠ¶æ€æ ä¸­çš„æ¨¡å¼æç¤º
    switchSection("auth");
    updateStatusBar(null);
</script>
</body>
</html>
