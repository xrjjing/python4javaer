# RBAC 示例项目结构说明（FastAPI 模块化视角）

> 本文帮助你把 RBAC 示例在脑中「归位」：它相当于 Java 里的一个独立模块/微服务，同时也展示了一个比较规范的 FastAPI 项目结构。

## 一、整体位置与定位

- 仓库层级：`rbac_auth_service/`（已从 `03.项目实战` 拆分为独立服务目录）
- 角色：
  - 对于本学习仓库：这是「Web 进阶线」的核心示例项目，也是一个可单独运行与复用的 RBAC 服务；
  - 对于工程实践：可以类比为一个独立的服务模块（Java 世界里的一个 service 模块 / 后端子工程）。

## 二、与 Java 分层的类比

Python 不强制使用 `req/rsp/util/filter/api/service/repository` 这种 Java 风格目录，但本项目尽量做了类比，让你迁移思维更自然：

- **Controller / API 层（Java 的 Controller）**
  - 位置：`app/routers/`
  - 文件：
    - `auth.py`：认证接口（登录 / 登出 / 当前用户）
    - `users.py`：用户管理接口
    - `roles.py`：角色 / 权限管理接口
    - `todos.py`：受 RBAC 控制的 TODO 接口
  - FastAPI 术语中通常叫「router」或「API 路由」，等价于 Java MVC 里的 Controller。

- **DTO / VO 层（Java 的 req/rsp 对象）**
  - 位置：`app/schemas.py`
  - 作用：使用 Pydantic 定义请求体 / 响应体模型（UserCreate、UserOut、TodoOut、Token 等），与 ORM 模型解耦。

- **实体与持久化（Java 的 Entity + Repository）**
  - 位置：
    - `app/models.py`：SQLAlchemy ORM 实体（User/Role/Permission/Todo + 关联表）
    - `app/database.py`：数据库引擎与 Session 管理（类似 DataSource + EntityManagerFactory）
  - 当前示例中，简单的 CRUD 直接在 router 中使用 Session 完成；
  - 若你更习惯 Java 的 Repository 层，可以在后续迭代中：
    - 新增 `app/repositories/` 目录，封装常用查询/写入逻辑；
    - router 只调用 repository + service，而不直接操作 Session。

- **Service / 业务层**
  - 当前项目规模下，业务逻辑相对简单，大部分直接在 router 中完成；
  - 你可以在未来扩展时新增：
    - `app/services/user_service.py`
    - `app/services/rbac_service.py`
    - `app/services/todo_service.py`
  - 然后把「复杂业务流程」写在 service 中（如批量授权、审计日志等），router 仅负责编排 HTTP 层。

- **安全与过滤（Java 的 filter/interceptor + security）**
  - 位置：
    - `app/security.py`：密码哈希、JWT 生成解析、Token 黑名单（Redis/内存）
    - `app/dependencies.py`：`get_current_user`、`require_superuser`、`require_roles`、`require_permissions` 等依赖
  - 在 FastAPI 中，`Depends(...)` 相当于「精细化的过滤器/拦截器」：
    - RBAC 检查通过依赖注入在进入路由前完成；
    - 与 Java 里的 Spring Security / Filter 链有相似思想，但更细粒度、显式。

- **应用入口与配置（Java 的 Application 启动类 + 配置）**
  - 入口：`app/main.py` → `create_app()` 工厂函数 + `app = create_app()`
  - 配置：
    - 数据库连接：`DATABASE_URL` 环境变量；
    - JWT：`SECRET_KEY`、`ACCESS_TOKEN_EXPIRE_MINUTES`；
    - Redis：`REDIS_URL`。

## 三、你可以如何在此基础上继续「模块化」演进

如果把这个示例当作真实项目的起点，下一步的合理演进路线可以是：

1. **抽出 repository 层**
   - 新建 `app/repositories/`，按实体拆分文件（user_repo.py、role_repo.py 等）；
   - 将所有 `db.query(...).filter(...)` 相关逻辑搬进去；
   - router 中只保留「接参 + 调用 service/repository + 返回结果」。

2. **抽出 service 层**
   - 新建 `app/services/`，将多步业务流程（例如：同时创建用户 + 默认角色 + 审计日志）集中在 service；
   - router 层变薄，可读性更强，也更接近 Java Service 的习惯。

3. **按业务域再细分**
   - 随着功能增大，可以按业务域拆分子包，例如：
     - `app/user/`（用户 + 角色 + 权限相关）
     - `app/todo/`（TODO 相关）
     - `app/core/`（安全、配置、通用异常处理）

在目前这个学习阶段，我刻意保持了「结构清晰但不过度切分」：

- 你能在一个目录里快速看到所有关键组成部分；
- 又能明显感受到各层职责的划分（models/schemas/routers/security/dependencies）。

等你对这一套足够熟悉之后，如果你希望，我可以再带你做一次「从当前结构重构到 service/repository 分层」的实战演练，把 RBAC 项目当成真实重构练习。+
