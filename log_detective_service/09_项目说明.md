# 日志侦探服务 (Log Detective Service)

## 1. 项目定位

日志侦探服务是一个专注于日志分析与安全检测的微服务，用于演示：
- **正则表达式**在日志解析中的实际应用
- **安全限制**：防止正则表达式 ReDoS 攻击的保护机制
- **内存处理**：不持久化原始日志，仅在内存中完成分析

在整个学习仓库的微服务链路中，本服务作为"专用分析工具"，通过网关接收日志文本，返回结构化的分析结果（错误统计、可疑 IP、关键错误记录等）。

**教学重点**：
- 正则表达式的实战应用（IP 提取、日志级别识别）
- 安全编程实践（输入限制、超时保护）
- FastAPI 的异步接口设计

## 2. 技术栈

- **框架**：FastAPI
- **数据验证**：Pydantic + pydantic-settings
- **核心能力**：正则表达式（re 模块）、多进程安全保护（multiprocessing）
- **依赖**：无数据库依赖，纯内存处理

## 3. 目录结构

```
log_detective_service/
├── app/
│   ├── __init__.py
│   ├── main.py          # FastAPI 应用入口
│   ├── config.py        # 配置管理（端口、限制参数）
│   ├── routes.py        # HTTP 路由层（/analyze 接口）
│   ├── schemas.py       # Pydantic 模型（请求/响应结构）
│   └── analyzer.py      # 核心分析逻辑（正则匹配、统计）
└── 09_项目说明.md       # 本文档
```

**各模块职责**：
- `main.py`：挂载路由，定义健康检查接口
- `config.py`：集中管理服务配置（端口、日志大小限制、正则超时等）
- `routes.py`：定义 `/internal/log-detective/analyze` 接口
- `schemas.py`：定义请求体（LogDetectiveRequest）和响应体（LogAnalysisResult）
- `analyzer.py`：实现日志分析核心逻辑，包含安全正则匹配函数（当前未启用）

## 4. 运行方式

### 4.1 依赖安装

本服务依赖已包含在根目录 `requirements.txt` 中，主要包括：
```bash
fastapi
uvicorn[standard]
pydantic
pydantic-settings
```

### 4.2 启动命令

```bash
# 在项目根目录执行
uvicorn log_detective_service.app.main:app --reload --port 9003
```

### 4.3 环境变量（可选）

服务支持通过环境变量覆盖默认配置：
- `SERVICE_NAME`：服务名称（默认：log_detective_service）
- `SERVICE_PORT`：服务端口（默认：8084，但通常通过 uvicorn 命令行指定为 9003）
- `MAX_LOG_SIZE`：最大日志文本大小（默认：2MB）
- `MAX_LOG_LINES`：最大处理行数（默认：50,000 行）
- `REGEX_TIMEOUT`：正则匹配超时（默认：2 秒）
- `MAX_RESULTS`：最大返回结果数（默认：1000）

## 5. API 概览

### 5.1 日志分析接口

**路径**：`POST /internal/log-detective/analyze`

**请求体**：
```json
{
  "log_text": "2023-10-27 10:00:01 [INFO] Service started\n...",
  "profile": "generic",
  "custom_regex": null,
  "max_results": 100
}
```

**响应体**：
```json
{
  "summary": {
    "total_lines": 150,
    "error_lines": 12,
    "warn_lines": 5
  },
  "suspicious_ips": [
    {"ip": "192.168.1.10", "count": 8, "reason": "多次错误/警告"}
  ],
  "critical_errors": [
    {"level": "ERROR", "message": "Database connection failed", "line_no": 45}
  ],
  "meta": {"truncated": false}
}
```

### 5.2 健康检查接口

**路径**：`GET /health` 或 `GET /internal/log-detective/health`

**响应**：
```json
{"status": "ok"}
```

**推荐**：启动服务后访问 `http://127.0.0.1:9003/docs` 查看 Swagger 文档并在线测试。

## 6. 与其他服务/前端的关系

### 6.1 上游服务

- **integration_gateway_service**（网关服务，端口 8000）
  - 网关路由：`POST /gateway/log-detective/analyze`
  - 转发到本服务：`POST /internal/log-detective/analyze`
  - 网关负责 JWT 验证和统一响应包装

### 6.2 前端页面

- **frontend/log-detective.html**
  - 用户在前端输入日志文本
  - 通过网关调用本服务进行分析
  - 展示分析结果（错误统计、可疑 IP、关键错误列表）

### 6.3 调用链路

```
用户浏览器 (log-detective.html)
    ↓ POST /gateway/log-detective/analyze
网关服务 (integration_gateway_service:8000)
    ↓ JWT 验证 + 转发
日志侦探服务 (log_detective_service:9003)
    ↓ 分析日志
返回结构化结果
```

## 7. 学习要点与练习建议

### 7.1 正则表达式实战

本服务的核心是 `analyzer.py` 中的正则表达式应用：
- **IP 地址提取**：`r'\b(?:\d{1,3}\.){3}\d{1,3}\b'`
- **日志级别识别**：通过 `'ERROR' in line.upper()` 等简单匹配

**练习建议**：
1. 尝试修改 `PATTERNS` 字典，添加新的日志格式支持
2. 实现时间戳提取功能，统计日志的时间范围
3. 扩展 IP 统计，区分"首次出现"和"最后出现"时间

### 7.2 安全编程实践

`analyzer.py` 中包含 `safe_regex_match()` 函数，演示如何防止正则表达式 ReDoS 攻击：
- 使用 `multiprocessing` 隔离正则匹配
- 使用 `signal.alarm()` 设置超时
- 当前**未启用**，仅作为教学示例

**注意**：`signal.alarm()` 在 Windows 上不可用，macOS/Linux 可正常使用。

**练习建议**：
1. 研究 ReDoS 攻击原理（如 `(a+)+b` 匹配 `aaaa...c`）
2. 尝试启用 `safe_regex_match()` 并测试超时保护
3. 思考：为什么当前实现选择"简单正则 + 行数限制"而非完全启用超时保护？

### 7.3 扩展方向

如果想将本服务扩展为更完整的日志分析工具，可以考虑：
1. **持久化**：新增 `repositories/` 层，保存分析历史到数据库
2. **异步任务**：对于大日志文件，使用后台任务 + 任务队列
3. **可视化**：返回时间序列数据，供前端绘制图表
4. **告警规则**：当错误率超过阈值时触发告警

## 8. 常见问题

**Q1：为什么端口是 9003 而不是配置文件中的 8084？**
- 配置文件中的 `SERVICE_PORT` 是默认值，实际运行时通过 `uvicorn --port 9003` 指定
- 这样可以避免端口冲突，同时保持配置的灵活性

**Q2：为什么不持久化日志？**
- 本服务定位为"即时分析工具"，不是日志存储系统
- 持久化日志应由专门的日志服务（如 `log_audit_service`）负责

**Q3：`safe_regex_match()` 为什么没有被使用？**
- 当前实现使用简单的预定义正则 + 行数/大小限制，已足够安全
- `safe_regex_match()` 作为"高级安全实践"的教学示例保留
- 如果未来开放自定义正则功能，可以启用该保护机制

## 9. 相关文档

- **整体架构**：见根目录 `README.md`
- **联调指南**：见 `网关_RBAC_后端联调说明.md` 中的"日志侦探"章节
- **前端说明**：见 `frontend/README.md`
- **正则表达式学习**：见 `01.Python语言基础/15_进阶专题/01_正则表达式/`