<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥å¿—ä¾¦æ¢ - Pythonå­¦ä¹ å¹³å°</title>
    <script src="config.js"></script>
    <script src="common.js"></script>
    <style>
:root { --primary: #4f46e5; --bg: #f1f5f9; --panel: #fff; --border: #e2e8f0; --error: #ef4444; --warning: #f59e0b; --text: #0f172a; --muted: #475569; }
@media (prefers-color-scheme: dark) {
  :root {
    --primary: #38bdf8;
    --bg: #0f172a;
    --panel: #111827;
    --border: #1f2937;
    --error: #ef4444;
    --warning: #f59e0b;
    --text: #e5e7eb;
    --muted: #94a3b8;
  }
  body { background: radial-gradient(circle at 20% 20%, rgba(56,189,248,0.12), transparent 25%), radial-gradient(circle at 80% 0%, rgba(167,139,250,0.12), transparent 22%), var(--bg); }
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: sans-serif; background: var(--bg); padding: 2rem; color: var(--text); }
.container { max-width: 1200px; margin: 0 auto; }
.header { background: var(--panel); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid var(--border); }
.header p { color: var(--muted); }
.input-section { background: var(--panel); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 2rem; }
textarea { width: 100%; height: 150px; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; color: var(--text); background: var(--panel); }
.btn { padding: 0.6rem 1.2rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; }
.btn-primary { background: var(--primary); color: #0b1120; }
.action-bar { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem; }
.results { display: none; }
.results.active { display: block; }
.stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
.stat-card { background: var(--panel); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--primary); }
.stat-value { font-size: 2rem; font-weight: 700; margin-top: 0.5rem; }
.panel { background: var(--panel); border-radius: 8px; border: 1px solid var(--border); margin-bottom: 2rem; }
.panel-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); font-weight: 600; }
table { width: 100%; border-collapse: collapse; color: var(--text); }
th, td { text-align: left; padding: 0.75rem 1.5rem; border-bottom: 1px solid var(--border); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ•µï¸ æ—¥å¿—ä¾¦æ¢</h1>
            <p>ç«¯åˆ°ç«¯ç»ƒä¹ ï¼šå‰ç«¯ â†’ ç½‘å…³ â†’ Pythonåˆ†ææœåŠ¡</p>
        </div>
        <div class="input-section">
            <h2>æäº¤æ—¥å¿—</h2>
            <textarea id="log-input" placeholder="ç²˜è´´æœåŠ¡å™¨æ—¥å¿—..."></textarea>
            <div class="action-bar">
                <button class="btn" onclick="loadSample()">åŠ è½½ç¤ºä¾‹</button>
                <button class="btn btn-primary" id="analyze-btn" onclick="analyze()">åˆ†ææ—¥å¿—</button>
            </div>
        </div>
        <div id="results" class="results">
            <div class="stats">
                <div class="stat-card"><div>æ€»è¡Œæ•°</div><div class="stat-value" id="stat-lines">0</div></div>
                <div class="stat-card"><div>é”™è¯¯</div><div class="stat-value" id="stat-errors">0</div></div>
                <div class="stat-card"><div>è­¦å‘Š</div><div class="stat-value" id="stat-warnings">0</div></div>
            </div>
            <div class="panel">
                <div class="panel-header">å¯ç–‘IP</div>
                <table><thead><tr><th>IP</th><th>æ¬¡æ•°</th><th>åŸå› </th></tr></thead><tbody id="ip-table"></tbody></table>
            </div>
            <div class="panel">
                <div class="panel-header">å…³é”®é”™è¯¯</div>
                <table><thead><tr><th>çº§åˆ«</th><th>æ¶ˆæ¯</th><th>è¡Œå·</th></tr></thead><tbody id="error-table"></tbody></table>
            </div>
        </div>
    </div>
    <script>
const API_BASE = window.AppConfig?.apiBaseUrl ?? window.API_BASE_URL ?? '';
function loadSample() {
    document.getElementById('log-input').value = '2023-10-27 10:00:01 [INFO] Service started\n2023-10-27 10:05:23 [WARN] High memory from 192.168.1.10\n2023-10-27 10:06:01 [ERROR] Database failed\n2023-10-27 10:07:12 [ERROR] Login failed from 203.0.113.42';
}
async function analyze() {
    const input = document.getElementById('log-input').value;
    if (!input.trim()) return alert('è¯·è¾“å…¥æ—¥å¿—');

    const token = localStorage.getItem('accessToken');
    if (!token) {
        alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨æ—¥å¿—ä¾¦æ¢åŠŸèƒ½');
        window.location.href = 'login.html';
        return;
    }

    const btn = document.getElementById('analyze-btn');
    btn.disabled = true;
    btn.textContent = 'åˆ†æä¸­...';
    try {
        const result = await apiClient(API_BASE + '/gateway/log-detective/analyze', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ log_text: input })
        });
        const data = result.data || result;
        document.getElementById('stat-lines').textContent = data.summary?.total_lines || 0;
        document.getElementById('stat-errors').textContent = data.summary?.error_lines || 0;
        document.getElementById('stat-warnings').textContent = data.summary?.warn_lines || 0;

        const ipTbody = document.getElementById('ip-table');
        ipTbody.replaceChildren();
        (data.suspicious_ips || []).forEach(ip => {
            const tr = document.createElement('tr');
            ['ip', 'count', 'reason'].forEach(key => {
                const td = document.createElement('td');
                td.textContent = String(ip[key] ?? '');
                tr.appendChild(td);
            });
            ipTbody.appendChild(tr);
        });

        const errTbody = document.getElementById('error-table');
        errTbody.replaceChildren();
        (data.critical_errors || []).forEach(err => {
            const tr = document.createElement('tr');
            ['level', 'message', 'line_no'].forEach(key => {
                const td = document.createElement('td');
                td.textContent = String(err[key] ?? '');
                tr.appendChild(td);
            });
            errTbody.appendChild(tr);
        });

        document.getElementById('results').classList.add('active');
    } catch (error) {
        alert('åˆ†æå¤±è´¥: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'åˆ†ææ—¥å¿—';
    }
}
    </script>
</body>
</html>
