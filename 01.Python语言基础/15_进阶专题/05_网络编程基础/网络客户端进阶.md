# 网络客户端进阶：urllib / requests / httpx（Mock）

> 目标：掌握常用同步客户端的超时、重试、Mock 测试方法；避免真实网络依赖，示例使用 httpx.MockTransport。

## 1. urllib 基础（内置，无第三方依赖）

```python
from urllib import request

req = request.Request('https://example.com', method='GET')
req.add_header('User-Agent', 'learn-bot/1.0')
with request.urlopen(req, timeout=5) as resp:
    print(resp.status)
    print(resp.read()[:100])
```

要点：手动添加 header、处理超时；不方便重试与 JSON 解析。

## 2. requests（同步）

```python
import requests

r = requests.get('https://example.com', timeout=5)
r.raise_for_status()
data = r.text
```

要点：简单、生态丰富；重试需自定义 Session + HTTPAdapter。

## 3. httpx（同步 + 异步，支持 MockTransport）

```python
import httpx

def build_client():
    transport = httpx.MockTransport(lambda request: httpx.Response(200, json={"ok": True}))
    return httpx.Client(timeout=5, transport=transport)

with build_client() as client:
    resp = client.get('https://api.test/mock')
    print(resp.json())
```

### 异步示例

```python
import httpx, asyncio

async def main():
    transport = httpx.MockTransport(lambda request: httpx.Response(200, json={"ok": True, "path": str(request.url)}))
    async with httpx.AsyncClient(timeout=5, transport=transport) as client:
        resp = await client.get('https://api.test/mock')
        print(resp.json())

asyncio.run(main())
```

## 4. 重试与超时（httpx）

```python
import time
import httpx


def build_retrying_client(retries: int = 3, backoff: float = 0.1):
    transport = httpx.MockTransport(lambda request: httpx.Response(503))

    def send_with_retry(request):
        attempt = 0
        while True:
            resp = transport.handle_request(request)
            if resp.status_code == 200 or attempt >= retries:
                return resp
            attempt += 1
            time.sleep(backoff * attempt)

    return httpx.Client(timeout=5, transport=httpx.MockTransport(send_with_retry))
```

## 5. 与本仓库的联系
- 网关服务（integration_gateway_service）使用 httpx 调用下游，可套用重试/超时逻辑。
- 日志侦探/审计服务测试时可用 MockTransport 替代真实下游，便于单测脱网运行。

## 6. 配套示例
- 运行：`python 01.Python语言基础/15_进阶专题/05_网络编程基础/demo_network_clients.py`
- 说明：示例使用 MockTransport，不依赖外网。
