# 正则表达式

正则表达式（Regular Expression）是处理字符串的强大工具，用于模式匹配、搜索、替换等操作。Python 通过 `re` 模块提供正则表达式支持。

## 目录

1. [基础语法](#1-基础语法)
2. [re模块核心函数](#2-re模块核心函数)
3. [分组与捕获](#3-分组与捕获)
4. [常用模式示例](#4-常用模式示例)
5. [高级特性](#5-高级特性)
6. [实战应用](#6-实战应用)

---

## 1. 基础语法

### 元字符

| 元字符 | 说明 | 示例 |
|--------|------|------|
| `.` | 匹配任意字符（除换行符） | `a.c` 匹配 `abc`、`adc` |
| `^` | 匹配字符串开头 | `^Hello` |
| `$` | 匹配字符串结尾 | `world$` |
| `*` | 匹配0次或多次 | `ab*` 匹配 `a`、`ab`、`abb` |
| `+` | 匹配1次或多次 | `ab+` 匹配 `ab`、`abb` |
| `?` | 匹配0次或1次 | `ab?` 匹配 `a`、`ab` |
| `{n}` | 精确匹配n次 | `a{3}` 匹配 `aaa` |
| `{n,}` | 匹配至少n次 | `a{2,}` 匹配 `aa`、`aaa` |
| `{n,m}` | 匹配n到m次 | `a{2,4}` 匹配 `aa`、`aaa`、`aaaa` |

### 字符类

| 字符类 | 说明 | 等价形式 |
|--------|------|----------|
| `\d` | 数字 | `[0-9]` |
| `\D` | 非数字 | `[^0-9]` |
| `\w` | 单词字符 | `[a-zA-Z0-9_]` |
| `\W` | 非单词字符 | `[^a-zA-Z0-9_]` |
| `\s` | 空白字符 | `[ \t\n\r\f\v]` |
| `\S` | 非空白字符 | `[^ \t\n\r\f\v]` |

### 自定义字符集

```python
import re

# [abc] - 匹配 a、b 或 c
re.findall(r'[abc]', 'abcdef')  # ['a', 'b', 'c']

# [a-z] - 匹配小写字母
re.findall(r'[a-z]+', 'Hello123')  # ['ello']

# [^abc] - 匹配除 a、b、c 外的字符
re.findall(r'[^abc]', 'abcdef')  # ['d', 'e', 'f']
```

**Java对比**：Python 正则语法与 Java 基本一致，但 Python 使用原始字符串 `r'...'` 避免双重转义。

---

## 2. re模块核心函数

### 2.1 match - 从头匹配

```python
import re

text = "Hello, Python!"
match = re.match(r'Hello', text)
if match:
    print(match.group())  # "Hello"
    print(match.span())   # (0, 5)
```

### 2.2 search - 搜索首个匹配

```python
text = "我的手机号是13800138000"
match = re.search(r'1[3-9]\d{9}', text)
if match:
    print(match.group())  # "13800138000"
```

### 2.3 findall - 查找所有匹配

```python
text = "电话：13800138000，备用：13900139000"
phones = re.findall(r'1[3-9]\d{9}', text)
print(phones)  # ['13800138000', '13900139000']
```

### 2.4 sub - 替换

```python
text = "联系电话：13800138000"

# 简单替换
masked = re.sub(r'\d{11}', '***********', text)
# "联系电话：***********"

# 部分隐藏（使用分组引用）
masked = re.sub(r'(\d{3})\d{4}(\d{4})', r'\1****\2', text)
# "联系电话：138****8000"
```

### 2.5 split - 分割

```python
text = "apple,banana;orange|grape"
parts = re.split(r'[,;|]', text)
print(parts)  # ['apple', 'banana', 'orange', 'grape']
```

### 2.6 compile - 编译正则

```python
# 频繁使用的模式应该预编译
phone_regex = re.compile(r'1[3-9]\d{9}')

texts = ["手机：13800138000", "联系：15912345678"]
for text in texts:
    match = phone_regex.search(text)
    if match:
        print(match.group())
```

**性能提示**：对于循环中多次使用的模式，`compile()` 可显著提升性能。

---

## 3. 分组与捕获

### 3.1 基本分组

```python
text = "张三的手机号是13800138000"
pattern = r'(\w+)的手机号是(\d{11})'
match = re.search(pattern, text)
if match:
    print(match.group(0))  # 完整匹配
    print(match.group(1))  # "张三"
    print(match.group(2))  # "13800138000"
    print(match.groups())  # ('张三', '13800138000')
```

### 3.2 命名分组

```python
text = "2025-01-15"
pattern = r'(?P<year>\d{4})-(?P<month>\d{2})-(?P<day>\d{2})'
match = re.search(pattern, text)
if match:
    print(match.group('year'))   # "2025"
    print(match.group('month'))  # "01"
    print(match.group('day'))    # "15"
    print(match.groupdict())     # {'year': '2025', 'month': '01', 'day': '15'}
```

### 3.3 非捕获分组

```python
# (?:...) 分组但不捕获
pattern = r'(?:https?://)?www\.(\w+)\.com'
match = re.search(pattern, 'https://www.example.com')
print(match.group(1))  # "example"（只有一个捕获组）
```

### 3.4 反向引用

```python
# \1 引用第一个分组的匹配结果
pattern = r'(\w+)\s+\1'  # 匹配重复单词
text = "hello hello world"
match = re.search(pattern, text)
print(match.group())  # "hello hello"
```

---

## 4. 常用模式示例

### 4.1 邮箱验证

```python
email_pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'

emails = ["user@example.com", "invalid@", "@bad.com"]
for email in emails:
    is_valid = bool(re.match(email_pattern, email))
    print(f"{email}: {'✓' if is_valid else '✗'}")
```

### 4.2 手机号验证

```python
phone_pattern = r'^1[3-9]\d{9}$'

phones = ["13800138000", "12345678901", "1380013800"]
for phone in phones:
    is_valid = bool(re.match(phone_pattern, phone))
    print(f"{phone}: {'✓' if is_valid else '✗'}")
```

### 4.3 身份证号验证

```python
id_pattern = r'^\d{17}[\dXx]$'

ids = ["110101199001011234", "11010119900101123X"]
for id_card in ids:
    is_valid = bool(re.match(id_pattern, id_card))
    print(f"{id_card}: {'✓' if is_valid else '✗'}")
```

### 4.4 URL提取

```python
url_pattern = r'https?://[^\s<>"]+|www\.[^\s<>"]+'

text = "访问 https://example.com 或 www.test.com"
urls = re.findall(url_pattern, text)
print(urls)  # ['https://example.com', 'www.test.com']
```

### 4.5 IP地址匹配

```python
ip_pattern = r'\b(?:\d{1,3}\.){3}\d{1,3}\b'

text = "服务器IP: 192.168.1.1, 网关: 192.168.1.254"
ips = re.findall(ip_pattern, text)
print(ips)  # ['192.168.1.1', '192.168.1.254']
```

---

## 5. 高级特性

### 5.1 贪婪与非贪婪

```python
html = "<div>内容1</div><div>内容2</div>"

# 贪婪匹配（默认）- 尽可能多匹配
greedy = re.findall(r'<div>.*</div>', html)
print(greedy)  # ['<div>内容1</div><div>内容2</div>']

# 非贪婪匹配 - 尽可能少匹配
non_greedy = re.findall(r'<div>.*?</div>', html)
print(non_greedy)  # ['<div>内容1</div>', '<div>内容2</div>']
```

### 5.2 匹配标志

| 标志 | 说明 | 示例 |
|------|------|------|
| `re.IGNORECASE` / `re.I` | 忽略大小写 | `re.findall(r'python', text, re.I)` |
| `re.MULTILINE` / `re.M` | 多行模式 | `^` 和 `$` 匹配每行 |
| `re.DOTALL` / `re.S` | `.` 匹配换行符 | 跨行匹配 |
| `re.VERBOSE` / `re.X` | 允许注释和空白 | 提高可读性 |

```python
# 忽略大小写
text = "Python is PYTHON"
matches = re.findall(r'python', text, re.IGNORECASE)
print(matches)  # ['Python', 'PYTHON']

# 多行模式
text = "第一行\n第二行\n第三行"
lines = re.findall(r'^第.*', text, re.MULTILINE)
print(lines)  # ['第一行', '第二行', '第三行']
```

### 5.3 前向/后向断言

```python
# (?=...) 前向肯定断言
# 匹配后面跟着"元"的数字
prices = re.findall(r'\d+(?=元)', '商品100元，运费20元')
print(prices)  # ['100', '20']

# (?<=...) 后向肯定断言
# 匹配前面是"¥"的数字
amounts = re.findall(r'(?<=¥)\d+', '价格¥100，折扣¥20')
print(amounts)  # ['100', '20']

# (?!...) 前向否定断言
# 匹配不以.jpg结尾的文件名
files = ['doc.pdf', 'img.jpg', 'data.csv']
pattern = r'\w+(?!\.jpg$)'
```

---

## 6. 实战应用

### 6.1 日志解析

```python
log_lines = [
    "2025-01-15 10:30:45 [INFO] 用户登录成功",
    "2025-01-15 10:31:20 [ERROR] 数据库连接失败",
]

log_pattern = r'(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}) \[(\w+)\] (.+)'

for line in log_lines:
    match = re.match(log_pattern, line)
    if match:
        timestamp, level, message = match.groups()
        print(f"时间: {timestamp}, 级别: {level}, 消息: {message}")
```

### 6.2 配置文件解析

```python
config_text = """
host = 127.0.0.1
port = 8080
debug = true
"""

config_pattern = r'(\w+)\s*=\s*(.+)'
config = dict(re.findall(config_pattern, config_text))
print(config)  # {'host': '127.0.0.1', 'port': '8080', 'debug': 'true'}
```

### 6.3 HTML内容提取

```python
html = "<h1>标题</h1><p>段落1</p><p>段落2</p>"

# 提取段落内容
paragraphs = re.findall(r'<p>(.*?)</p>', html)
print(paragraphs)  # ['段落1', '段落2']

# 去除HTML标签
clean_text = re.sub(r'<[^>]+>', '', html)
print(clean_text)  # "标题段落1段落2"
```

### 6.4 敏感信息脱敏

```python
def mask_sensitive_data(text):
    # 手机号脱敏
    text = re.sub(r'(\d{3})\d{4}(\d{4})', r'\1****\2', text)
    # 邮箱脱敏
    text = re.sub(r'(\w{2})[\w.]+(@\w+\.\w+)', r'\1***\2', text)
    # 身份证脱敏
    text = re.sub(r'(\d{6})\d{8}(\d{4})', r'\1********\2', text)
    return text

info = "手机13800138000，邮箱user@example.com，身份证110101199001011234"
print(mask_sensitive_data(info))
```

---

## 7. 最佳实践

### 何时使用正则

| 场景 | 推荐方案 |
|------|----------|
| 简单字符串查找 | `in` 或 `str.find()` |
| 简单分割 | `str.split()` |
| 简单替换 | `str.replace()` |
| 复杂模式匹配 | 正则表达式 |
| 数据验证 | 正则表达式 |
| 文本提取 | 正则表达式 |

### 性能提示

1. **预编译**：频繁使用的模式用 `re.compile()`
2. **避免回溯**：减少 `.*` 的使用，优先用非贪婪或具体字符类
3. **锚定匹配**：使用 `^` 和 `$` 限定匹配范围
4. **简单优先**：能用字符串方法解决的不用正则

### 与Java的对比

| Python | Java |
|--------|------|
| `re.search(pattern, text)` | `Pattern.compile(pattern).matcher(text).find()` |
| `re.match(pattern, text)` | `Pattern.compile(pattern).matcher(text).matches()` |
| `re.findall(pattern, text)` | 需要循环调用 `matcher.find()` |
| `re.sub(pattern, repl, text)` | `text.replaceAll(pattern, repl)` |
| 原始字符串 `r'\d+'` | 需要转义 `"\\d+"` |

---

## 8. 练习建议

1. **邮箱提取**：从文本中提取所有邮箱地址
2. **日志分析**：解析Web服务器日志，统计访问IP
3. **数据清洗**：从HTML中提取纯文本内容
4. **格式转换**：将日期格式从"2025/01/15"转为"2025-01-15"

## 在本仓库中的应用

- **日志分析项目**：`03.项目实战/02_日志分析与报表生成/` 中使用正则解析日志格式
- **log_audit_service**：审计日志的时间戳和字段解析
- **爬虫项目**：`03.项目实战/05_简单爬虫_新闻标题抓取/` 中提取 HTML 内容
- **综合练习**：参见 `15_进阶专题.md` 中的"审计日志分析与报表生成"练习

配合 `practice_regex.py` 完成对应练习。

## 相关资源

- [Python官方文档 - re模块](https://docs.python.org/zh-cn/3/library/re.html)
- [正则表达式在线测试](https://regex101.com/)
- [正则表达式可视化](https://regexper.com/)
