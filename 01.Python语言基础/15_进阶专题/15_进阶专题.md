# 15_进阶专题

> 本章为语言基础的进阶补充，涵盖实际开发中常用但未在前面章节详细讲解的主题。

## 目录结构

- `01_正则表达式/`
  正则表达式基础、常用模式、re模块使用

- `02_标准库常用模块/`
  datetime、collections、itertools、functools等

- `03_文件与目录操作/`
  os、shutil、pathlib深入使用

- `04_数据序列化/`
  JSON、pickle、CSV、XML处理

- `05_网络编程基础/`
  socket、HTTP请求、requests库

- `06_多线程与多进程/`
  threading、multiprocessing基础

- `07_异步编程入门/`
  asyncio、async/await基础

## 学习建议

1. 完成前14章后再学习本章内容
2. 每个专题都有独立的demo和practice文件
3. 结合项目实战中的代码理解应用场景
4. 根据工作需要选择性深入学习

## 与项目实战的对应关系

| 专题 | 关联项目 | 关联服务 |
|------|----------|----------|
| 正则表达式 | 日志分析项目 | log_audit_service 日志解析 |
| 标准库模块 | 所有项目通用 | 各服务中的 datetime/collections 使用 |
| 文件操作 | 批量重命名、日志归档 | 日志归档脚本 |
| 数据序列化 | 数据分析、API项目 | 各服务的 JSON schema、配置读取 |
| 网络编程 | 爬虫、系统对接 | integration_gateway_service |
| 并发编程 | 性能优化场景 | 批处理任务 |
| 异步编程 | FastAPI高级用法 | rbac_auth_service、gateway 的 async 路由 |

---

## 综合实战练习

> 本节通过一个综合练习，串联本章 7 个子专题的核心技能。

### 练习：审计日志分析与报表生成

**目标**：从 log_audit_service 获取审计日志，解析、聚合并生成报表。

**涉及技能**：
- 正则表达式：解析日志结构
- 标准库模块：datetime 处理时间、collections 统计
- 文件操作：读写文件
- 数据序列化：JSON/CSV 导出
- 网络编程：HTTP 请求获取日志
- 异步编程：可选的异步请求优化

### 任务步骤

#### 步骤 1：从日志服务获取数据（网络编程）

```python
import requests

def fetch_audit_logs(base_url: str = "http://localhost:8002") -> list:
    """从 log_audit_service 获取审计日志"""
    response = requests.get(f"{base_url}/logs")
    response.raise_for_status()
    data = response.json()
    return data.get("data", data)  # 兼容 APIResponse 结构
```

#### 步骤 2：解析日志结构（正则 + 标准库）

```python
import re
from datetime import datetime
from collections import Counter, defaultdict

def parse_logs(logs: list) -> dict:
    """解析并聚合日志数据"""
    stats = {
        "total": len(logs),
        "by_action": Counter(),
        "by_actor": Counter(),
        "by_date": defaultdict(list),
    }

    for log in logs:
        stats["by_action"][log.get("action", "unknown")] += 1
        stats["by_actor"][log.get("actor", "unknown")] += 1

        # 解析时间戳
        created_at = log.get("created_at", "")
        if created_at:
            # 支持 ISO 格式：2025-01-15T10:30:00
            date_match = re.match(r"(\d{4}-\d{2}-\d{2})", created_at)
            if date_match:
                date_key = date_match.group(1)
                stats["by_date"][date_key].append(log)

    return stats
```

#### 步骤 3：生成报表（数据序列化）

```python
import json
import csv
from pathlib import Path

def export_report(stats: dict, output_dir: str = "./reports"):
    """导出报表到 JSON 和 CSV"""
    output_path = Path(output_dir)
    output_path.mkdir(exist_ok=True)

    # JSON 报表
    json_report = {
        "total_logs": stats["total"],
        "action_distribution": dict(stats["by_action"]),
        "actor_distribution": dict(stats["by_actor"]),
        "daily_count": {k: len(v) for k, v in stats["by_date"].items()},
    }

    with open(output_path / "audit_report.json", "w", encoding="utf-8") as f:
        json.dump(json_report, f, ensure_ascii=False, indent=2)

    # CSV 报表（按日期统计）
    with open(output_path / "daily_stats.csv", "w", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow(["日期", "日志数量"])
        for date, logs in sorted(stats["by_date"].items()):
            writer.writerow([date, len(logs)])

    print(f"报表已生成到 {output_path}")
```

#### 步骤 4：主程序

```python
def main():
    # 1. 获取日志
    print("正在获取审计日志...")
    logs = fetch_audit_logs()
    print(f"获取到 {len(logs)} 条日志")

    # 2. 解析统计
    print("正在分析日志...")
    stats = parse_logs(logs)

    # 3. 输出摘要
    print(f"\n=== 审计日志分析报告 ===")
    print(f"总日志数: {stats['total']}")
    print(f"\n操作类型分布:")
    for action, count in stats["by_action"].most_common(5):
        print(f"  {action}: {count}")
    print(f"\n活跃用户 Top 5:")
    for actor, count in stats["by_actor"].most_common(5):
        print(f"  {actor}: {count}")

    # 4. 导出报表
    export_report(stats)

if __name__ == "__main__":
    main()
```

### 进阶挑战

1. **异步版本**：使用 `httpx` + `asyncio` 并行获取多个日志服务的数据
2. **实时监控**：使用多线程定时拉取日志，检测异常操作并告警
3. **可视化**：将统计结果输出为 HTML 报表或接入简单图表库

### 参考文件

- `practice_regex.py`：正则表达式练习
- `practice_stdlib.py`：标准库练习
- `practice_files_dirs.py`：文件操作练习
- `practice_serialization.py`：序列化练习
- `practice_networking.py`：网络编程练习
- `practice_async_programming.py`：异步编程练习
