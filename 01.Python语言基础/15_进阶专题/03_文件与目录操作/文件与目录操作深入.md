# 文件与目录操作深入

> 本专题在你已经掌握第 8 章「异常与文件基础」和第 14 章中 pathlib/with 等写法的基础上，系统整理「文件与目录操作」这一大块，帮助你在真实项目中写出既安全又高效的文件处理代码。

配套示例代码：

- `01.Python语言基础/15_进阶专题/03_文件与目录操作/demo_files_dirs.py`
- 建议后续补充：`practice_files_dirs.py` 作为练习题文件

---

## 目录

1. [路径表示与 Pathlib 进阶](#1-路径表示与-pathlib-进阶)
2. [遍历目录与文件过滤](#2-遍历目录与文件过滤)
3. [复制、移动、删除与压缩](#3-复制移动删除与压缩)
4. [临时文件与安全删除](#4-临时文件与安全删除)
5. [综合实战：日志目录整理小工具](#5-综合实战日志目录整理小工具)

---

## 1. 路径表示与 Pathlib 进阶

在第 14 章中你已经见过 `pathlib.Path` 的基础用法，这里再系统补充一些常见模式，帮助你尽量避开裸 `os.path`。

常见优势：

- 更易读：运算符 `/` 直接拼接路径；
- 跨平台：自动处理 Windows / POSIX 风格差异；
- 更丰富的方法：`iterdir()`、`glob()`、`read_text()`、`write_text()` 等。

示例（更多细节见 `demo_files_dirs.py`）：

```python
from pathlib import Path

project_root = Path(__file__).resolve().parents[3]
logs_dir = project_root / "logs"

# 判断/创建目录
if not logs_dir.exists():
    logs_dir.mkdir(parents=True)

# 读取/写入文本
config_path = project_root / "config" / "settings.ini"
if config_path.is_file():
    text = config_path.read_text(encoding="utf-8")
```

建议习惯：

- 在脚本中尽量使用 `Path` 及其方法，而不是字符串 + `os.path.join`；
- 对于读写文本/二进制文件，优先使用 `Path.read_text` / `read_bytes` / `write_text` / `write_bytes`。

---

## 2. 遍历目录与文件过滤

遍历目录是批量处理文件时最常见的需求，例如：

- 批量重命名、批量删除、批量归档；
- 搜索特定扩展名的文件（`.log`、`.csv` 等）；
- 做简单的文件统计（大小、修改时间等）。

常见模式：

1. 只遍历当前目录：`Path.iterdir()`；
2. 递归遍历：`rglob()` 或 `glob("**/*")`；
3. 模式过滤：`glob("*.log")`、`glob("**/*.csv")`。

在 `demo_files_dirs.py` 中你会看到类似函数：

```python
def find_files_by_suffix(root: Path, suffix: str) -> list[Path]:
    \"\"\"递归查找指定后缀的所有文件。\"\"\"
    return [p for p in root.rglob(f"*{suffix}") if p.is_file()]
```

实践建议：

- 把「遍历 + 过滤」封装成小函数，避免在业务代码中重复写 for + if；
- 配合 `stat()` 获取大小、修改时间等元数据，做更精细的过滤。

---

## 3. 复制、移动、删除与压缩

标准库 `shutil` 提供了对文件和目录的常见高阶操作：

- `shutil.copy` / `copy2`：复制文件；
- `shutil.move`：移动文件或目录；
- `shutil.rmtree`：递归删除目录（⚠️ 高危操作，慎用）；
- `shutil.make_archive`：打包压缩目录（zip/tar 等）。

在 `demo_files_dirs.py` 中，你可以看到类似的封装：

```python
import shutil

def copy_tree(src: Path, dst: Path) -> None:
    \"\"\"复制整个目录树到目标位置。\"\"\"
    if not src.is_dir():
        raise ValueError(f\"源目录不存在：{src}\")
    dst.parent.mkdir(parents=True, exist_ok=True)
    shutil.copytree(src, dst, dirs_exist_ok=True)
```

安全性建议：

- 删除前尽量增加一层「dry-run」模拟模式（只打印将要执行的操作）；
- 对 `rmtree` 这类 API 保持敬畏：限制只允许在某个「工作根目录」下操作；
- 配合日志记录关键操作（删除、移动、重命名等）。

压缩归档和 `03.项目实战/06_自动化脚本_日志归档` 中的逻辑可以互相参考，你可以尝试把其中的代码重构为通用工具函数。

---

## 4. 临时文件与安全删除

在编写脚本/服务时，经常需要：

- 临时保存某些中间结果；
- 下载/解压临时文件；
- 保证临时文件最终会被清理。

标准库中可以使用 `tempfile`：

```python
import tempfile

with tempfile.TemporaryDirectory() as tmp_dir:
    # 在 tmp_dir 中进行各种操作
    ...
    # 代码块结束时，目录会自动删除
```

与前面章节中的 `with` 语句结合，可以实现「创建 → 使用 → 自动清理」的一次性流程，避免手动写 try/finally。

在 `demo_files_dirs.py` 中，也会演示如何用临时目录来做文件处理的单元测试/实验环境。

---

## 5. 综合实战：日志目录整理小工具

为了把本专题的知识串起来，`demo_files_dirs.py` 中给出一个「日志目录整理」的小示例，目标场景大致如下：

- 有一个长期运行的服务，每天生成日志文件：`app-2024-01-01.log`、`app-2024-01-02.log` 等；
- 希望定期将「超过 N 天的日志」移动到归档目录，甚至压缩成 zip 包；
- 希望保留最近 N 天的日志在主目录中，方便快速排查问题。

示例思路：

1. 使用 `Path.rglob("*.log")` 查找所有日志文件；
2. 根据文件名或修改时间判断是否「过期」；
3. 使用 `shutil.move` 或 `shutil.make_archive` 把旧日志移动/压缩到归档目录；
4. 通过命令行参数控制阈值天数、源目录、目标目录等。

建议你对照该示例，尝试完成以下练习（可以在后续的 `practice_files_dirs.py` 中实现）：

- 增加「dry-run」模式，只打印不真正移动/删除；
- 增加「按服务分子目录」的逻辑（例如按前缀分组：`web-*.log`、`worker-*.log`）；  
- 扩展支持按文件大小阈值进行归档（例如超过 100MB 的日志先压缩再移动）。

掌握本专题后，你在处理「批量文件脚本」和「日志/报表等目录维护脚本」时会更游刃有余，也能更好地读懂和改造 `03.项目实战` 中与文件相关的项目代码。

---

## 在本仓库中的应用

- **log_audit_service**：审计日志持久化存储，可扩展为文件归档
- **03.项目实战/06_自动化脚本_日志归档**：完整的日志归档脚本实现，使用 `shutil`、`pathlib` 进行文件操作
- **各服务配置读取**：`config.py` 中使用 `pathlib` 定位配置文件路径
- **综合练习**：参见 `15_进阶专题.md` 中的"审计日志分析与报表生成"，涉及文件写入（CSV/JSON 导出）

**Java 对比**：
- Python `pathlib.Path` ≈ Java `java.nio.file.Path`
- Python `shutil` ≈ Java `Files.copy()` / `Files.move()`
- Python `tempfile` ≈ Java `Files.createTempDirectory()`

## 相关资源

- [Python官方文档 - pathlib](https://docs.python.org/zh-cn/3/library/pathlib.html)
- [Python官方文档 - shutil](https://docs.python.org/zh-cn/3/library/shutil.html)
- [Python官方文档 - tempfile](https://docs.python.org/zh-cn/3/library/tempfile.html)
