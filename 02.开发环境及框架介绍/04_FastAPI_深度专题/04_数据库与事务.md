# 04 æ•°æ®åº“ä¸äº‹åŠ¡ï¼šSQLAlchemy 2.0ï¼ˆFastAPI vs Java è§†è§’ï¼‰

> é¢å‘å¯¹è±¡ï¼šä» Java / Spring / Hibernate è¿ç§»åˆ° Python / FastAPI çš„åŒå­¦ã€‚
> ç›®æ ‡ï¼šæŒæ¡ SQLAlchemy 2.0 çš„åŒæ­¥/å¼‚æ­¥æ•°æ®è®¿é—®ã€Session ç®¡ç†ã€äº‹åŠ¡æ§åˆ¶ä¸è¿æ¥æ± é…ç½®ï¼Œç†è§£ä¸ JPA/Hibernate çš„å¯¹åº”å…³ç³»ã€‚

---

## 0. å¿«é€Ÿå¯¹ç…§ï¼šJPA/Hibernate vs SQLAlchemy

| ç»´åº¦ | Java (JPA/Hibernate) | SQLAlchemy 2.0 |
| --- | --- | --- |
| å·¥å‚ | `EntityManagerFactory` | `sessionmaker` / `async_sessionmaker` |
| ä¼šè¯ | `EntityManager` | `Session` / `AsyncSession` |
| äº‹åŠ¡ | `@Transactional` | `with session.begin()` / `async with` |
| è¿æ¥æ±  | HikariCP | å†…ç½® Poolï¼ˆ`pool_size`, `max_overflow`ï¼‰ |
| æŸ¥è¯¢è¯­è¨€ | JPQL / HQL | SQLAlchemy `select()` / Core SQL |
| å…³ç³»æ˜ å°„ | `@OneToMany` / `@ManyToOne` | `relationship()` + `back_populates` |
| æ‡’åŠ è½½ | é»˜è®¤ LAZY | `lazy="select"` / `selectinload` / `joinedload` |

**è®°å¿†å¥**ï¼šSQLAlchemy Session â‰ˆ EntityManagerï¼Œä½†æ›´æ˜¾å¼â€”â€”commit å‰è‡ªåŠ¨ flushï¼Œå¯é€šè¿‡ `autoflush` æ§åˆ¶æŸ¥è¯¢å‰è¡Œä¸ºã€‚

---

## 1. ç¯å¢ƒå‡†å¤‡ä¸é©±åŠ¨é€‰æ‹©

### 1.1 å®‰è£…ä¾èµ–

```bash
# åŒæ­¥ + å¼‚æ­¥
pip install "sqlalchemy>=2.0" fastapi uvicorn

# å¼‚æ­¥é©±åŠ¨ï¼ˆæŒ‰æ•°æ®åº“é€‰æ‹©ï¼‰
pip install aiosqlite      # SQLite å¼‚æ­¥
pip install asyncpg        # PostgreSQL å¼‚æ­¥
pip install aiomysql       # MySQL å¼‚æ­¥

# åŒæ­¥é©±åŠ¨
pip install psycopg2-binary  # PostgreSQL åŒæ­¥
```

### 1.2 é©±åŠ¨é€‰æ‹©å¯¹ç…§

| æ•°æ®åº“ | åŒæ­¥é©±åŠ¨ | å¼‚æ­¥é©±åŠ¨ | DSN ç¤ºä¾‹ |
| --- | --- | --- | --- |
| SQLite | å†…ç½® | aiosqlite | `sqlite+aiosqlite:///./app.db` |
| PostgreSQL | psycopg2 | asyncpg | `postgresql+asyncpg://user:pwd@host/db` |
| MySQL | pymysql | aiomysql | `mysql+aiomysql://user:pwd@host/db` |

---

## 2. åŒæ­¥ SQLAlchemy åˆå§‹åŒ–

### 2.1 åŸºæœ¬è®¾ç½®

```python
from sqlalchemy import create_engine, Column, Integer, String
from sqlalchemy.orm import sessionmaker, declarative_base, Session

# Java å¯¹æ¯”ï¼šEntityManagerFactory
engine = create_engine(
    "sqlite:///./demo.db",
    echo=True,  # æ‰“å° SQLï¼Œè°ƒè¯•ç”¨
    future=True,
)

# Java å¯¹æ¯”ï¼šEntityManager å·¥å‚
SessionLocal = sessionmaker(
    bind=engine,
    autoflush=False,
    autocommit=False,
    future=True,
)

Base = declarative_base()

class User(Base):
    __tablename__ = "users"
    id = Column(Integer, primary_key=True)
    name = Column(String(50), nullable=False)

# åˆ›å»ºè¡¨
Base.metadata.create_all(bind=engine)
```

### 2.2 FastAPI ä¾èµ–æ³¨å…¥

```python
from typing import Generator
from fastapi import FastAPI, Depends

app = FastAPI()

def get_session() -> Generator[Session, None, None]:
    """è¯·æ±‚çº§ Sessionï¼Œç±»ä¼¼ Spring @RequestScope EntityManager"""
    db = SessionLocal()
    try:
        yield db
        db.commit()  # æˆåŠŸæäº¤
    except Exception:
        db.rollback()  # å¼‚å¸¸å›æ»š
        raise
    finally:
        db.close()  # ç¡®ä¿å…³é—­

@app.post("/users")
def create_user(name: str, db: Session = Depends(get_session)):
    user = User(name=name)
    db.add(user)
    db.flush()  # ç«‹å³è·å–è‡ªå¢ ID
    return {"id": user.id, "name": user.name}
```

---

## 3. å¼‚æ­¥ SQLAlchemy åˆå§‹åŒ–

### 3.1 åŸºæœ¬è®¾ç½®

```python
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import declarative_base, Mapped, mapped_column

# å¼‚æ­¥å¼•æ“
engine = create_async_engine(
    "sqlite+aiosqlite:///./demo_async.db",
    echo=True,
    future=True,
)

# å¼‚æ­¥ Session å·¥å‚
AsyncSessionLocal = async_sessionmaker(
    bind=engine,
    autoflush=False,
    autocommit=False,
    expire_on_commit=False,  # æäº¤åä¸è¿‡æœŸå¯¹è±¡å±æ€§
)

Base = declarative_base()

class User(Base):
    __tablename__ = "users"
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column()

# å¼‚æ­¥åˆ›å»ºè¡¨
async def init_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
```

### 3.2 FastAPI å¼‚æ­¥ä¾èµ–

```python
from typing import AsyncGenerator
from fastapi import FastAPI, Depends

app = FastAPI()

async def get_session() -> AsyncGenerator[AsyncSession, None]:
    """å¼‚æ­¥è¯·æ±‚çº§ Session"""
    async with AsyncSessionLocal() as session:
        try:
            yield session
            await session.commit()
        except Exception:
            await session.rollback()
            raise

@app.post("/users")
async def create_user(name: str, session: AsyncSession = Depends(get_session)):
    user = User(name=name)
    session.add(user)
    await session.flush()
    return {"id": user.id, "name": user.name}
```

### 3.3 åŒæ­¥ vs å¼‚æ­¥å¯¹æ¯”

| æ“ä½œ | åŒæ­¥ | å¼‚æ­¥ |
| --- | --- | --- |
| å¼•æ“ | `create_engine()` | `create_async_engine()` |
| Session å·¥å‚ | `sessionmaker()` | `async_sessionmaker()` |
| è·å– Session | `SessionLocal()` | `async with AsyncSessionLocal()` |
| æäº¤ | `session.commit()` | `await session.commit()` |
| æŸ¥è¯¢ | `session.execute(stmt)` | `await session.execute(stmt)` |

---

## 4. è¿æ¥æ± é…ç½®

### 4.1 å‚æ•°å¯¹ç…§

| SQLAlchemy | HikariCP | è¯´æ˜ |
| --- | --- | --- |
| `pool_size` | `maximumPoolSize` | å›ºå®šè¿æ¥æ•° |
| `max_overflow` | - | çªå‘é¢å¤–è¿æ¥ï¼ˆHikariCP æ— ç›´æ¥å¯¹åº”ï¼‰ |
| `pool_timeout` | `connectionTimeout` | è·å–è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰ |
| `pool_recycle` | `maxLifetime` | è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸï¼ˆç§’ï¼‰ |
| `pool_pre_ping` | - | å€Ÿå‡ºå‰ ping æ£€æµ‹ï¼ˆé˜²åƒµå°¸è¿æ¥ï¼‰ |

### 4.2 ç”Ÿäº§é…ç½®ç¤ºä¾‹

```python
engine = create_engine(
    "postgresql+psycopg2://user:pwd@localhost:5432/demo",
    pool_size=10,         # å¸¸é©» 10 ä¸ªè¿æ¥
    max_overflow=5,       # çªå‘å¯å†åˆ›å»º 5 ä¸ª
    pool_timeout=30,      # è·å–è¿æ¥è¶…æ—¶ 30 ç§’
    pool_recycle=1800,    # 30 åˆ†é’Ÿå›æ”¶ï¼Œé¿å… MySQL "gone away"
    pool_pre_ping=True,   # æ¯æ¬¡å€Ÿå‡ºå‰æ£€æµ‹è¿æ¥æœ‰æ•ˆæ€§
    echo=False,
    future=True,
)
```

### 4.3 å¸¸è§é—®é¢˜

| ç°è±¡ | åŸå›  | è§£å†³ |
| --- | --- | --- |
| "QueuePool limit reached" | è¿æ¥æ³„æ¼æˆ–å¹¶å‘è¿‡é«˜ | æ£€æŸ¥ Session æ˜¯å¦æ­£ç¡®å…³é—­ï¼›å¢å¤§ pool_size |
| "MySQL server has gone away" | è¿æ¥è¶…æ—¶è¢«æœåŠ¡ç«¯æ–­å¼€ | è®¾ç½® `pool_recycle` < æ•°æ®åº“ wait_timeout |
| å¶å‘ "broken pipe" | åƒµå°¸è¿æ¥ | å¯ç”¨ `pool_pre_ping=True` |

---

## 5. äº‹åŠ¡æ§åˆ¶

### 5.1 åŸºæœ¬æäº¤/å›æ»š

```python
def basic_transaction():
    db = SessionLocal()
    try:
        db.add(User(name="alice"))
        db.commit()  # æˆåŠŸæäº¤
    except Exception:
        db.rollback()  # å¤±è´¥å›æ»š
        raise
    finally:
        db.close()
```

### 5.2 ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆæ¨èï¼‰

```python
def context_manager():
    # ç±»ä¼¼ Spring @Transactionalï¼Œè‡ªåŠ¨æäº¤/å›æ»š
    with SessionLocal.begin() as db:
        db.add(User(name="bob"))
    # ç¦»å¼€ with å—è‡ªåŠ¨æäº¤ï¼›å¼‚å¸¸è‡ªåŠ¨å›æ»š
```

### 5.3 åµŒå¥—äº‹åŠ¡ä¸ Savepoint

**åŒæ­¥ç‰ˆæœ¬ï¼š**
```python
def nested_transaction():
    with SessionLocal.begin() as db:
        db.add(User(name="outer"))

        try:
            with db.begin_nested():  # Savepoint
                db.add(User(name="inner"))
                raise ValueError("æ¨¡æ‹Ÿå†…å±‚å¤±è´¥")
        except ValueError:
            pass  # å†…å±‚å›æ»šï¼Œå¤–å±‚ç»§ç»­

        db.add(User(name="after_nested"))
    # ç»“æœï¼šouter å’Œ after_nested æäº¤ï¼Œinner å›æ»š
```

**å¼‚æ­¥ç­‰ä»·å†™æ³•ï¼š**
```python
async def async_nested_transaction():
    async with AsyncSessionLocal() as session:
        async with session.begin():
            session.add(User(name="outer"))

            try:
                async with session.begin_nested():  # å¼‚æ­¥ Savepoint
                    session.add(User(name="inner"))
                    raise ValueError("æ¨¡æ‹Ÿå†…å±‚å¤±è´¥")
            except ValueError:
                pass

            session.add(User(name="after_nested"))
```

### 5.4 Java å¯¹æ¯”

| Java | SQLAlchemy | è¯´æ˜ |
| --- | --- | --- |
| `@Transactional` | `with session.begin()` | å£°æ˜å¼ vs ä¸Šä¸‹æ–‡ç®¡ç† |
| `@Transactional(propagation=NESTED)` | `session.begin_nested()` | åµŒå¥—äº‹åŠ¡/Savepoint |
| `TransactionTemplate` | æ‰‹åŠ¨ `commit()/rollback()` | ç¼–ç¨‹å¼äº‹åŠ¡ |

---

## 6. ORM æŸ¥è¯¢æ¨¡å¼ï¼ˆSQLAlchemy 2.0 é£æ ¼ï¼‰

### 6.1 åŸºæœ¬ CRUD

```python
from sqlalchemy import select, update, delete

# ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨è·å– Session
with SessionLocal() as session:
    # SELECT
    stmt = select(User).where(User.name == "alice")
    users = session.execute(stmt).scalars().all()

    # INSERT
    user = User(name="carol")
    session.add(user)
    session.flush()  # ç«‹å³è·å–è‡ªå¢ ID

    # UPDATE
    stmt = update(User).where(User.id == 1).values(name="alice_updated")
    session.execute(stmt)

    # DELETE
    stmt = delete(User).where(User.id == 1)
    session.execute(stmt)

    session.commit()
```

### 6.2 æ‰¹é‡æ“ä½œ

```python
# æ‰¹é‡æ’å…¥
session.add_all([User(name="u1"), User(name="u2"), User(name="u3")])
session.commit()

# æ‰¹é‡æ›´æ–°
session.execute(update(User).where(User.name.like("u%")).values(name="batch"))
session.commit()
```

### 6.3 æŸ¥è¯¢è¯­æ³•å¯¹æ¯”

| JPQL/HQL | SQLAlchemy 2.0 |
| --- | --- |
| `SELECT u FROM User u WHERE u.name = :name` | `select(User).where(User.name == "alice")` |
| `UPDATE User SET name = :name WHERE id = :id` | `update(User).where(User.id == 1).values(name="new")` |
| `DELETE FROM User WHERE id = :id` | `delete(User).where(User.id == 1)` |

---

## 7. å…³ç³»æ˜ å°„ä¸åŠ è½½ç­–ç•¥

### 7.1 å®šä¹‰å…³ç³»

```python
from sqlalchemy import ForeignKey
from sqlalchemy.orm import relationship, Mapped, mapped_column

class User(Base):
    __tablename__ = "users"
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str]
    # Java å¯¹æ¯”ï¼š@OneToMany(mappedBy = "user")
    orders: Mapped[list["Order"]] = relationship("Order", back_populates="user")

class Order(Base):
    __tablename__ = "orders"
    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[int] = mapped_column(ForeignKey("users.id"))
    amount: Mapped[int]
    # Java å¯¹æ¯”ï¼š@ManyToOne
    user: Mapped[User] = relationship("User", back_populates="orders")
```

### 7.2 åŠ è½½ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | SQL è¡Œä¸º | é€‚ç”¨åœºæ™¯ | Java å¯¹åº” |
| --- | --- | --- | --- |
| `lazy="select"` | è®¿é—®æ—¶å•ç‹¬æŸ¥è¯¢ | é»˜è®¤ï¼Œå¯èƒ½ N+1 | `FetchType.LAZY` |
| `selectinload()` | IN å­æŸ¥è¯¢æ‰¹é‡åŠ è½½ | ä¸€å¯¹å¤šåˆ—è¡¨ | `@BatchSize` |
| `joinedload()` | JOIN ä¸€æ¬¡æŸ¥è¯¢ | å¤šå¯¹ä¸€/å°‘é‡å…³è” | `FetchType.EAGER` + JOIN |

### 7.3 ä½¿ç”¨ç¤ºä¾‹

```python
from sqlalchemy.orm import selectinload, joinedload

with SessionLocal() as session:
    # é»˜è®¤ lazy - å¯èƒ½ N+1
    users = session.execute(select(User)).scalars().all()
    for u in users:
        print(u.orders)  # æ¯æ¬¡å¾ªç¯é¢å¤–æŸ¥è¯¢ï¼

    # selectinload - æ¨èä¸€å¯¹å¤šï¼ˆâ‰ˆ Hibernate @BatchSizeï¼‰
    users = session.execute(
        select(User).options(selectinload(User.orders))
    ).scalars().all()

    # joinedload - é€‚åˆå¤šå¯¹ä¸€ï¼ˆâ‰ˆ FetchType.EAGER + JOINï¼‰
    orders = session.execute(
        select(Order).options(joinedload(Order.user))
    ).scalars().all()
```

---

## 8. å®Œæ•´ FastAPI é›†æˆç¤ºä¾‹

```python
# main.py
import asyncio
from typing import AsyncGenerator
from fastapi import FastAPI, Depends, HTTPException
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
from sqlalchemy.orm import declarative_base, Mapped, mapped_column
from sqlalchemy import select
from pydantic import BaseModel

# é…ç½®
DATABASE_URL = "sqlite+aiosqlite:///./app.db"

engine = create_async_engine(DATABASE_URL, echo=True)
AsyncSessionLocal = async_sessionmaker(engine, expire_on_commit=False)
Base = declarative_base()

# ORM æ¨¡å‹
class UserORM(Base):
    __tablename__ = "users"
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str]
    email: Mapped[str]

# Pydantic æ¨¡å‹ï¼ˆæ‰¿æ¥ç¬¬3ç« ï¼‰
class UserCreate(BaseModel):
    name: str
    email: str

class UserResponse(BaseModel):
    id: int
    name: str
    email: str
    model_config = {"from_attributes": True}

# åˆå§‹åŒ–
async def init_db():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)

# ä¾èµ–æ³¨å…¥ï¼ˆæ‰¿æ¥ç¬¬2ç« ï¼‰
async def get_session() -> AsyncGenerator[AsyncSession, None]:
    async with AsyncSessionLocal() as session:
        try:
            yield session
            await session.commit()
        except Exception:
            await session.rollback()
            raise

# FastAPI åº”ç”¨
app = FastAPI(title="SQLAlchemy 2.0 + FastAPI")

@app.on_event("startup")
async def on_startup():
    await init_db()

@app.post("/users", response_model=UserResponse)
async def create_user(user: UserCreate, session: AsyncSession = Depends(get_session)):
    db_user = UserORM(name=user.name, email=user.email)
    session.add(db_user)
    await session.flush()
    return db_user

@app.get("/users/{user_id}", response_model=UserResponse)
async def get_user(user_id: int, session: AsyncSession = Depends(get_session)):
    result = await session.execute(select(UserORM).where(UserORM.id == user_id))
    user = result.scalar_one_or_none()
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    return user

@app.get("/users", response_model=list[UserResponse])
async def list_users(session: AsyncSession = Depends(get_session)):
    result = await session.execute(select(UserORM))
    return result.scalars().all()
```

---

## 9. âš ï¸ å¸¸è§é™·é˜±

### 9.1 Java å¼€å‘è€…å¸¸è¸©å‘

1. **å¼‚æ­¥è·¯ç”±ç”¨åŒæ­¥ Session**
   - é—®é¢˜ï¼šé˜»å¡äº‹ä»¶å¾ªç¯ï¼Œæ€§èƒ½æš´è·Œ
   - è§£å†³ï¼šå¼‚æ­¥è·¯ç”±å¿…é¡»ç”¨ `AsyncSession`

2. **Session æœªå…³é—­**
   - é—®é¢˜ï¼šè¿æ¥æ³„æ¼ï¼Œæœ€ç»ˆ "QueuePool limit"
   - è§£å†³ï¼šä½¿ç”¨ `try/finally` æˆ– `async with`

3. **expire_on_commit é™·é˜±**
   - é—®é¢˜ï¼šæäº¤åè®¿é—®å¯¹è±¡å±æ€§è§¦å‘æ‡’åŠ è½½ï¼ŒSession å·²å…³é—­æŠ¥é”™
   - è§£å†³ï¼šè®¾ç½® `expire_on_commit=False` æˆ–æå‰åŠ è½½æ•°æ®

4. **N+1 æŸ¥è¯¢**
   - é—®é¢˜ï¼šé»˜è®¤ lazy åŠ è½½ï¼Œå¾ªç¯è®¿é—®å…³ç³»è§¦å‘å¤§é‡ SQL
   - è§£å†³ï¼šä½¿ç”¨ `selectinload()` æˆ– `joinedload()`

5. **äº‹åŠ¡æ··ç”¨**
   - é—®é¢˜ï¼šåŒæ—¶ä½¿ç”¨å¤šä¸ª Session æˆ–æ··ç”¨åŒæ­¥/å¼‚æ­¥
   - è§£å†³ï¼šä¸€ä¸ªè¯·æ±‚ä¸€ä¸ª Sessionï¼Œä¿æŒä¸€è‡´æ€§

### 9.2 å¸¸è§é”™è¯¯æ—¥å¿—

```
# è¿æ¥æ³„æ¼
sqlalchemy.exc.TimeoutError: QueuePool limit of size 5 overflow 10 reached

# Session å·²å…³é—­
sqlalchemy.orm.exc.DetachedInstanceError: Instance <User> is not bound to a Session

# åƒµå°¸è¿æ¥
OperationalError: (psycopg2.OperationalError) server closed the connection unexpectedly
```

---

## 10. ğŸ’¡ æœ€ä½³å®è·µ

1. **è¯·æ±‚çº§ Session**ï¼šæ¯ä¸ªè¯·æ±‚ä¸€ä¸ª Sessionï¼Œé€šè¿‡ DI ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
2. **å¼‚æ­¥ä¼˜å…ˆ**ï¼šé«˜å¹¶å‘åœºæ™¯ä½¿ç”¨ `AsyncSession` + å¼‚æ­¥é©±åŠ¨
3. **è¿æ¥æ± è°ƒä¼˜**ï¼šæ ¹æ®å¹¶å‘é‡è®¾ç½® `pool_size`ï¼Œå¯ç”¨ `pool_pre_ping`
4. **æ˜¾å¼åŠ è½½**ï¼šé¿å… N+1ï¼Œä¸»åŠ¨ä½¿ç”¨ `selectinload`/`joinedload`
5. **Pydantic è¾¹ç•Œ**ï¼šORM æ¨¡å‹ä¸ Pydantic æ¨¡å‹åˆ†ç¦»ï¼Œåœ¨è·¯ç”±å±‚è½¬æ¢
6. **äº‹åŠ¡èŒƒå›´æœ€å°åŒ–**ï¼šå°½æ—©æäº¤ï¼Œé¿å…é•¿äº‹åŠ¡é”è¡¨

---

## 11. ç»ƒä¹ 

### ç»ƒä¹  1ï¼šè¯·æ±‚çº§ Session

å®ç°åŒæ­¥å’Œå¼‚æ­¥ä¸¤ä¸ªç‰ˆæœ¬çš„ `get_session()` ä¾èµ–ï¼Œç¡®ä¿ï¼š
- æˆåŠŸæ—¶æäº¤
- å¼‚å¸¸æ—¶å›æ»š
- å§‹ç»ˆå…³é—­è¿æ¥

### ç»ƒä¹  2ï¼šå…³ç³»åŠ è½½å¯¹æ¯”

åˆ›å»º User-Order ä¸€å¯¹å¤šå…³ç³»ï¼š
- åˆ†åˆ«ç”¨ lazy/selectinload/joinedload æŸ¥è¯¢
- å¼€å¯ `echo=True` å¯¹æ¯” SQL æ¬¡æ•°
- è®°å½•æ€§èƒ½å·®å¼‚

### ç»ƒä¹  3ï¼šåµŒå¥—äº‹åŠ¡

å®ç°è½¬è´¦æ¥å£ï¼š
- ä½¿ç”¨ `begin_nested()` åˆ›å»º Savepoint
- æ¨¡æ‹Ÿç¬¬äºŒæ­¥å¤±è´¥ï¼Œä»…å›æ»šå­äº‹åŠ¡
- å¤–å±‚äº‹åŠ¡æäº¤æ“ä½œæ—¥å¿—

### ç»ƒä¹  4ï¼šè¿æ¥æ± å‹æµ‹

ä½¿ç”¨ locust æˆ– ab å‹æµ‹ï¼š
- å¯¹æ¯” `pool_size=5` vs `pool_size=20`
- æµ‹è¯• `pool_pre_ping=True/False` å¯¹é”™è¯¯ç‡å½±å“

---

## 12. Java vs Python å°è´´å£«

| åœºæ™¯ | Java ä¹ æƒ¯ | SQLAlchemy æ–¹å¼ |
| --- | --- | --- |
| äº‹åŠ¡å£°æ˜ | `@Transactional` | `with session.begin()` |
| æ‡’åŠ è½½å¼‚å¸¸ | `LazyInitializationException` | `DetachedInstanceError` |
| æ‰¹é‡æ’å…¥ | `entityManager.persist()` å¾ªç¯ | `session.add_all()` |
| åŸç”Ÿ SQL | `@Query(nativeQuery=true)` | `session.execute(text("..."))` |
| äºŒçº§ç¼“å­˜ | Hibernate L2 Cache | éœ€æ‰‹åŠ¨é›†æˆï¼ˆå¦‚ dogpile.cacheï¼‰ |
| Schema è¿ç§» | Flyway / Liquibase | Alembic |

---

## 13. å°ç»“

- SQLAlchemy 2.0 æä¾›åŒæ­¥/å¼‚æ­¥åŒæ¨¡å¼ï¼Œè¯­æ³•ç»Ÿä¸€
- `sessionmaker`/`async_sessionmaker` å¯¹åº” Java EntityManagerFactory
- äº‹åŠ¡æ§åˆ¶ä½¿ç”¨ `with session.begin()` ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œæ›´æ˜¾å¼å®‰å…¨
- è¿æ¥æ± é€šè¿‡ `pool_size`/`max_overflow`/`pool_pre_ping` é…ç½®
- é¿å… N+1ï¼šä¸»åŠ¨ä½¿ç”¨ `selectinload()`/`joinedload()`
- FastAPI é›†æˆï¼šDI ç®¡ç† Session ç”Ÿå‘½å‘¨æœŸï¼ŒPydantic åšæ•°æ®è¾¹ç•Œ
