# 02.å¼€å‘ç¯å¢ƒåŠæ¡†æ¶ä»‹ç»

> ç›®æ ‡ï¼šåœ¨å·²ç»æŒæ¡åŸºç¡€è¯­æ³•çš„å‰æä¸‹ï¼Œç³»ç»Ÿæ­å»ºä¸€å¥—ã€Œå¯æŒç»­å¼€å‘ã€çš„ Python å¼€å‘ç¯å¢ƒï¼Œå¹¶å¯¹å¸¸ç”¨æ¡†æ¶æœ‰æ•´ä½“è®¤è¯†ï¼Œä¸ºåç»­é¡¹ç›®å®æˆ˜åšå‡†å¤‡ã€‚

å»ºè®®ä½ åœ¨å®Œæˆ `01.Pythonè¯­è¨€åŸºç¡€` çš„å‰ 8ï½9 ç« åï¼Œå†ç³»ç»Ÿå­¦ä¹ æœ¬ç« èŠ‚å†…å®¹ã€‚

---

## ç›®å½•ç»“æ„å»ºè®®

ï¼ˆä½ å¯ä»¥æ ¹æ®éœ€è¦é€æ­¥åˆ›å»ºå¯¹åº”å­ç›®å½•å’Œç¤ºä¾‹ä»£ç ï¼‰

- `01_å¼€å‘å·¥å…·ä¸äº¤äº’ç¯å¢ƒ`  
  PyCharm é…ç½®ã€ç»ˆç«¯ / REPLã€`ipython`ã€Jupyter Notebookã€‚

- `02_è™šæ‹Ÿç¯å¢ƒä¸ä¾èµ–ç®¡ç†`  
  `venv`ã€`pip`ã€`requirements.txt`ã€ç®€å•å¤šç¯å¢ƒç®¡ç†æ€è·¯ã€‚

- `03_é¡¹ç›®ç»“æ„ä¸ä»£ç ç»„ç»‡`  
  æ¨èçš„ `src/` å¸ƒå±€ã€åŒ…ç»“æ„ã€é…ç½®åˆ†ç¦»ã€‚

- `04_Webæ¡†æ¶æ¦‚è§ˆä¸ FastAPI å…¥é—¨`  
  Flask / FastAPI / Django å¯¹æ¯”ï¼Œé€‰æ‹© FastAPI ä½œä¸ºæœ¬ä»“åº“çš„ä¸»çº¿ Web æ¡†æ¶ã€‚

- `05_æ•°æ®åˆ†ææ ˆæ¦‚è§ˆ`  
  `numpy`ã€`pandas` åŸºæœ¬è®¤çŸ¥ä¸ç®€å•ç¤ºä¾‹ã€‚

ä¸‹é¢ç»™å‡ºè¯¦ç»†è¯´æ˜å’Œå…³é”®ç¤ºä¾‹ï¼Œä½ å¯ä»¥è§†å­¦ä¹ è¿›åº¦æŒ‰éœ€é˜…è¯»ã€‚

---

## 01_å¼€å‘å·¥å…·ä¸äº¤äº’ç¯å¢ƒ

### 1. PyCharm åŸºæœ¬é…ç½®å»ºè®®

- æ¯ä¸ªé¡¹ç›®å•ç‹¬é…ç½®è§£é‡Šå™¨ï¼Œä½¿ç”¨é¡¹ç›®ä¸‹çš„ `.venv`ã€‚
- å¯ç”¨ä»¥ä¸‹åŠŸèƒ½ï¼š
  - ã€ŒOn Saveã€æˆ–ã€ŒCode Cleanupã€ï¼šè‡ªåŠ¨æ ¼å¼åŒ–ï¼ˆå¦‚ä½¿ç”¨ `black`ï¼‰
  - ä»£ç æ£€æŸ¥ï¼ˆå¦‚ `flake8` / `ruff` é›†æˆï¼‰
  - ç±»å‹æç¤ºä¸è¡¥å…¨ï¼ˆPylance / å†…å»ºæ£€æŸ¥ï¼‰

### 2. REPL ä¸å¿«é€Ÿè¯•éªŒ

- åœ¨ç»ˆç«¯è¾“å…¥ `python` å³å¯è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œé€‚åˆå¿«é€Ÿè¯•éªŒä¸€å°æ®µä»£ç ã€‚
- å»ºè®®å®‰è£… `ipython` æå‡ä½“éªŒï¼š

  ```bash
  pip install ipython
  ipython
  ```

### 3. Jupyter Notebookï¼ˆå¯é€‰ï¼‰

- ç”¨äºæ•°æ®åˆ†æ / å¯è§†åŒ–æ—¶æ›´ç›´è§‚ï¼š

  ```bash
  pip install notebook
  jupyter notebook
  ```

---

## 02_è™šæ‹Ÿç¯å¢ƒä¸ä¾èµ–ç®¡ç†

> è™šæ‹Ÿç¯å¢ƒçš„æ ¸å¿ƒæ€æƒ³ï¼š**ä¸åŒé¡¹ç›®çš„ä¾èµ–äº’ä¸å¹²æ‰°**ã€‚

### 1. ä½¿ç”¨ venv åˆ›å»ºç¯å¢ƒ

åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼š

```bash
python -m venv .venv
source .venv/bin/activate  # macOS / Linux
```

### 2. ä½¿ç”¨ pip å®‰è£…ä¸å¯¼å‡ºä¾èµ–

```bash
pip install requests
pip freeze > requirements.txt
```

å®‰è£…åˆ«äººé¡¹ç›®çš„ä¾èµ–æ—¶ï¼š

```bash
pip install -r requirements.txt
```

### 3. å¤šç¯å¢ƒç®¡ç†æ€è·¯ï¼ˆäº†è§£å³å¯ï¼‰

- æœ¬åœ°å¼€å‘ä½¿ç”¨ `venv` å³å¯æ»¡è¶³ç»å¤§å¤šæ•°éœ€æ±‚ã€‚
- éœ€è¦å¤šç‰ˆæœ¬ Python æ—¶å¯ä»¥äº†è§£ï¼š
  - `pyenv`ï¼šç®¡ç†å¤šç‰ˆæœ¬ Python
  - `pipx`ï¼šéš”ç¦»å®‰è£…å‘½ä»¤è¡Œå·¥å…·

---

## 03_é¡¹ç›®ç»“æ„ä¸ä»£ç ç»„ç»‡

### 1. æ¨èçš„é¡¹ç›®ç»“æ„ï¼ˆé€‚ç”¨äºä¸­å°å‹é¡¹ç›®ï¼‰

```text
.
â”œâ”€â”€ docs/                      # æ–‡æ¡£ï¼ˆå­¦ä¹ è§„åˆ’ã€é¡¹ç›®è¯´æ˜ç­‰ï¼‰
â”œâ”€â”€ src/                       # æºä»£ç 
â”‚   â””â”€â”€ your_package_name/     # é¡¶å±‚åŒ…ï¼ˆä¾‹å¦‚ learn_py/ï¼‰
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ config.py
â”‚       â”œâ”€â”€ main.py
â”‚       â””â”€â”€ ...
â”œâ”€â”€ tests/                     # æµ‹è¯•ä»£ç ï¼ˆpytestï¼‰
â”œâ”€â”€ requirements.txt           # è¿è¡Œæ—¶ä¾èµ–
â””â”€â”€ pyproject.toml / setup.py  # ï¼ˆå¯é€‰ï¼‰æ‰“åŒ…å’Œå…ƒæ•°æ®
```

### 2. é…ç½®ä¸å¸¸é‡

- é¿å…åœ¨ä»£ç ä¸­åˆ°å¤„ç¡¬ç¼–ç å¸¸é‡ï¼Œå¯é›†ä¸­åˆ° `config.py` æˆ–ç¯å¢ƒå˜é‡ã€‚
- ç¤ºä¾‹ï¼ˆ`src/your_package_name/config.py`ï¼‰ï¼š

```python
import os

DB_URL = os.getenv("DB_URL", "sqlite:///./app.db")
```

---

## 04_Web æ¡†æ¶æ¦‚è§ˆä¸ FastAPI å…¥é—¨

### 1. å¸¸è§ Web æ¡†æ¶å¯¹æ¯”ï¼ˆç®€ç•¥ï¼‰

- Flaskï¼šæç®€ã€çµæ´»ï¼Œé€‚åˆå°å‹æœåŠ¡ã€åŸå‹å¼€å‘ã€‚
- Djangoï¼šã€Œå¤§è€Œå…¨ã€ï¼Œè‡ªå¸¦ ORMã€ç®¡ç†åå°ï¼Œé€‚åˆä¼ ç»Ÿç½‘ç«™å’Œä¸­å¤§å‹é¡¹ç›®ã€‚
- FastAPIï¼šä¸“æ³¨ APIï¼Œç±»å‹æç¤ºå‹å¥½ï¼Œè‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ï¼Œæ€§èƒ½å¥½ã€‚

è¿™äº› Web æ¡†æ¶çš„**å…±åŒå¥½å¤„**å¤§è‡´åŒ…æ‹¬ï¼š

- ğŸ§­ å¸®ä½ å¤„ç† HTTP ç»†èŠ‚ï¼šè·¯ç”±åŒ¹é…ã€è¯·æ±‚/å“åº”è§£æã€çŠ¶æ€ç ç­‰ã€Œé‡å¤ä½“åŠ›æ´»ã€ï¼›
- ğŸ§© æä¾›ä¸­é—´ä»¶ / æ’ä»¶ä½“ç³»ï¼šè®¤è¯ã€æ—¥å¿—ã€è·¨åŸŸï¼ˆCORSï¼‰ã€é™æµç­‰å¯ä»¥å¤ç”¨ç¤¾åŒºæ–¹æ¡ˆï¼›
- ğŸ§± ç»Ÿä¸€é¡¹ç›®ç»“æ„ï¼šè·¯ç”±ã€æ¨¡å‹ã€é…ç½®å„å¸å…¶èŒï¼Œæ–¹ä¾¿å¤šäººåä½œå’Œé•¿æœŸç»´æŠ¤ï¼›
- ğŸŒ± æ‹¥æœ‰æˆç†Ÿç”Ÿæ€ï¼šORMã€æ–‡æ¡£ç”Ÿæˆã€è°ƒè¯•å·¥å…·ã€è„šæ‰‹æ¶æ¨¡æ¿ä¸€åº”ä¿±å…¨ã€‚

é’ˆå¯¹æœ¬ä»“åº“çš„ä½¿ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬é€‰ç”¨ **FastAPI** ä½œä¸º REST API å®æˆ˜çš„ä¸»çº¿æ¡†æ¶ï¼Œä¸»è¦åŸå› ï¼š

- ä¸ Python ç±»å‹æ³¨è§£æ·±åº¦ç»“åˆï¼Œå¯¹ Java å¼€å‘è€…æ›´å‹å¥½ï¼ˆæ„Ÿè§‰åƒåœ¨å†™ã€Œå¸¦æ³›å‹çš„æ¥å£ã€ï¼‰ï¼›
- è‡ªå¸¦äº¤äº’å¼æ¥å£æ–‡æ¡£ï¼ˆSwagger UI / ReDocï¼‰ï¼Œå¼€å‘å’Œè‡ªæµ‹ä½“éªŒå¥½ï¼›
- é»˜è®¤æ”¯æŒå¼‚æ­¥ I/Oï¼Œé€‚åˆé«˜å¹¶å‘æ¥å£æœåŠ¡ï¼›
- ç¤¾åŒºç¤ºä¾‹å¤šï¼Œæ˜“äºå‚è€ƒå’Œæ‰©å±•ã€‚

### 2. FastAPI æœ€å°å¯è¿è¡Œç¤ºä¾‹

> å»ºè®®åœ¨ `03.é¡¹ç›®å®æˆ˜/03_TODO_Web_API_FastAPI` æˆ–ä½ è‡ªå·±çš„ `src/api_fastapi_demo/` ä¸‹åˆ›å»ºç±»ä¼¼ç¤ºä¾‹ç›®å½•ã€‚

```python
# src/api_fastapi_demo/main.py

from fastapi import FastAPI

app = FastAPI()


@app.get("/ping")
def ping():
    return {"message": "pong"}
```

å®‰è£…ä¾èµ–å¹¶è¿è¡Œï¼š

```bash
pip install fastapi "uvicorn[standard]"
uvicorn api_fastapi_demo.main:app --reload
```

æµè§ˆå™¨è®¿é—®ï¼š`http://127.0.0.1:8000/ping` å’Œ `/docs`ã€‚

### 3. FastAPI å¸¸ç”¨ç”¨æ³•ä¸æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥ï¼ˆå¿…é¡»æŒæ¡ï¼‰

ä¸‹é¢è¿™äº›æ¦‚å¿µï¼Œæ˜¯åé¢åš TODO é¡¹ç›®æ—¶ä¸€å®šä¼šç”¨åˆ°çš„ï¼š

- è·¯ç”±ï¼ˆPath Operationï¼‰ï¼š`@app.get("/path")`ã€`@app.post("/path")` ç­‰ï¼›
- è¯·æ±‚å‚æ•°ï¼š
  - è·¯å¾„å‚æ•°ï¼ˆ`/users/{user_id}`ï¼‰
  - æŸ¥è¯¢å‚æ•°ï¼ˆ`/items?page=1&size=10`ï¼‰
  - è¯·æ±‚ä½“ï¼ˆJSONï¼Œä½¿ç”¨ Pydantic æ¨¡å‹æè¿°ï¼‰
- å“åº”æ¨¡å‹ï¼šé€šè¿‡ `response_model=...` æŒ‡å®šè¿”å›ç»“æ„ï¼›
- ä¾èµ–æ³¨å…¥ï¼ˆ`Depends`ï¼‰ï¼šç»Ÿä¸€æ³¨å…¥æ•°æ®åº“ä¼šè¯ã€é…ç½®ã€æƒé™æ ¡éªŒï¼›
- ä¸­é—´ä»¶ / CORSï¼šåœ¨è¯·æ±‚è¿›å…¥å’Œå“åº”è¿”å›æ—¶åšç»Ÿä¸€å¤„ç†ï¼›
- å¼‚å¸¸å¤„ç†ï¼š`HTTPException` + è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨ï¼›
- æµ‹è¯•ï¼šä½¿ç”¨ `fastapi.testclient.TestClient` ä¸ pytestã€‚

ä¸‹é¢é€šè¿‡å‡ ä¸ªå°ä¾‹å­å¿«é€Ÿç†Ÿæ‚‰è¿™äº›æ¦‚å¿µã€‚

#### 3.1 è·¯å¾„å‚æ•°ã€æŸ¥è¯¢å‚æ•°ã€è¯·æ±‚ä½“

```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()


class Item(BaseModel):
    name: str
    price: float
    on_sale: bool = False


@app.get("/users/{user_id}")
def read_user(user_id: int, verbose: bool = False):
    # user_id æ˜¯è·¯å¾„å‚æ•°ï¼Œverbose æ˜¯æŸ¥è¯¢å‚æ•°
    return {"user_id": user_id, "verbose": verbose}


@app.post("/items", response_model=Item)
def create_item(item: Item):
    # item è‡ªåŠ¨ä»è¯·æ±‚ä½“ JSON ååºåˆ—åŒ–å¹¶æ ¡éªŒ
    return item
```

#### 3.2 ä¾èµ–æ³¨å…¥ï¼ˆDependsï¼‰å’Œæ•°æ®åº“ä¼šè¯

ä¾èµ–æ³¨å…¥æ˜¯ FastAPI çš„ã€Œå¿…ä¿®è¯¾ã€ï¼Œå®˜æ–¹ç¤ºä¾‹å’Œ GitHub ä¸Šå¤§å¤šæ•° FastAPI é¡¹ç›®éƒ½ä¼šç”¨å®ƒæ¥ç®¡ç†ï¼š

- æ•°æ®åº“ä¼šè¯ï¼ˆSessionï¼‰
- å½“å‰ç”¨æˆ·ä¿¡æ¯
- ç»Ÿä¸€é…ç½®å¯¹è±¡

åœ¨æˆ‘ä»¬çš„ TODO é¡¹ç›®ä¸­ï¼Œ`get_db` å°±æ˜¯ä¸€ä¸ªå…¸å‹ä¾èµ–ï¼š

```python
# æ‘˜è‡ª 03_TODO_Web_API_FastAPI/app/database.py
from sqlalchemy.orm import Session
from .database import SessionLocal


def get_db() -> Session:
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

åœ¨è·¯ç”±ä¸­ä½¿ç”¨ï¼š

```python
from fastapi import Depends
from sqlalchemy.orm import Session
from .database import get_db


@app.get("/items")
def list_items(db: Session = Depends(get_db)):
    # db å°±æ˜¯ä¸€æ¬¡è¯·æ±‚å†…çš„æ•°æ®åº“ä¼šè¯
    ...
```

è¿™æ ·å†™çš„å¥½å¤„ï¼š  
å¦‚æœä»¥åä½ æƒ³æ¢æ•°æ®åº“ï¼Œæˆ–å¢åŠ äº‹åŠ¡æ§åˆ¶ã€æ—¥å¿—ï¼Œåªæ”¹ `get_db` å³å¯ã€‚

#### 3.3 è·¯ç”±æ‹†åˆ†ä¸æ¨¡å—åŒ–ï¼ˆAPIRouterï¼‰

å½“é¡¹ç›®å˜å¤§æ—¶ï¼ŒæŠŠæ‰€æœ‰æ¥å£éƒ½å†™åœ¨ `main.py` ä¼šéå¸¸ä¹±ã€‚  
GitHub ä¸Šå‡ ä¹æ‰€æœ‰ä¸­å¤§å‹ FastAPI é¡¹ç›®éƒ½ä¼šä½¿ç”¨ `APIRouter` æŠŠä¸åŒé¢†åŸŸçš„æ¥å£æ‹†æˆå¤šä¸ªæ¨¡å—ã€‚

æˆ‘ä»¬çš„ TODO å®æˆ˜é¡¹ç›®é‡‡ç”¨çš„å°±æ˜¯è¿™ç§ç»“æ„ï¼š

```python
# 03_TODO_Web_API_FastAPI/app/routers/todos.py
from fastapi import APIRouter

router = APIRouter(prefix="/todos", tags=["todos"])


@router.get("/")
def list_todos():
    ...
```

ç„¶ååœ¨ `main.py` ä¸­ç»Ÿä¸€æŒ‚è½½ï¼š

```python
# 03_TODO_Web_API_FastAPI/app/main.py
from fastapi import FastAPI
from .routers import todos

app = FastAPI()
app.include_router(todos.router)
```

è¿™ç§ã€ŒæŒ‰é¢†åŸŸæ‹†åˆ†è·¯ç”±ã€çš„æ–¹å¼ï¼Œæ˜¯ä½ ä»¥ååœ¨å·¥ä½œä¸­å†™ FastAPI é¡¹ç›®æ—¶å¿…å¤‡çš„ä»£ç ç»„ç»‡æ€è·¯ã€‚

#### 3.4 å¼‚å¸¸ä¸é”™è¯¯å¤„ç†

å¸¸è§åšæ³•ï¼š

- ä¸šåŠ¡å‡ºé”™æ—¶æŠ› `HTTPException`ï¼ŒæŒ‡å®š `status_code` å’Œ `detail`ï¼›
- å¯¹äºå…¨å±€æ€§çš„é”™è¯¯ï¼ˆä¾‹å¦‚æ•°æ®åº“è¿æ¥å¼‚å¸¸ï¼‰å¯ä»¥æ³¨å†Œè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨ã€‚

```python
from fastapi import HTTPException, status


@app.get("/items/{item_id}")
def read_item(item_id: int):
    item = get_item_from_db(item_id)
    if not item:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Item not found",
        )
    return item
```

> åœ¨æˆ‘ä»¬çš„ TODO é¡¹ç›®ä¸­ï¼Œæ‰¾ä¸åˆ°æŸä¸ª TODO ä¹Ÿä¼šæŠ› 404ï¼Œè¿™æ˜¯ FastAPI é€šç”¨åšæ³•ã€‚

#### 3.5 ä¸­é—´ä»¶ä¸ CORSï¼ˆäº†è§£ï¼‰

åœ¨ç”Ÿäº§é¡¹ç›®ä¸­ç»å¸¸ä¼šï¼š

- æ·»åŠ  CORS æ”¯æŒï¼ˆå…è®¸å‰ç«¯ç½‘ç«™è®¿é—® APIï¼‰ï¼›
- ç»Ÿä¸€è®°å½•è¯·æ±‚æ—¥å¿—ã€ç»Ÿè®¡è€—æ—¶ã€‚

```python
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
import time

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)


@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    start = time.time()
    response = await call_next(request)
    process_time = time.time() - start
    response.headers["X-Process-Time"] = str(process_time)
    return response
```

#### 3.6 åå°ä»»åŠ¡ï¼ˆBackgroundTasksï¼Œäº†è§£ï¼‰

é€‚ç”¨äºã€Œæ¥å£è¦å¿«é€Ÿè¿”å›ï¼Œä½†æœ‰ä¸€äº›åç»­æ“ä½œå¯ä»¥å¼‚æ­¥æ…¢æ…¢åšã€çš„åœºæ™¯ï¼Œå¦‚å‘é€é‚®ä»¶ã€å†™å®¡è®¡æ—¥å¿—ç­‰ã€‚

```python
from fastapi import BackgroundTasks


def write_log(message: str) -> None:
    with open("events.log", "a", encoding="utf-8") as f:
        f.write(message + "\n")


@app.post("/events")
def create_event(event: str, bg: BackgroundTasks):
    bg.add_task(write_log, f"new event: {event}")
    return {"status": "ok"}
```

#### 3.7 æµ‹è¯•ï¼ˆTestClient + pytestï¼Œäº†è§£ï¼‰

FastAPI éå¸¸é€‚åˆç”¨ pytest åšæ¥å£æµ‹è¯•ã€‚å®˜æ–¹å’Œ GitHub ä¸Šå¾ˆå¤šé¡¹ç›®éƒ½ä¼šæœ‰ç±»ä¼¼çš„ç»“æ„ï¼š

```python
# tests/test_todo_api.py
from fastapi.testclient import TestClient

# éœ€å…ˆåœ¨å‘½ä»¤è¡Œåˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•ï¼š
# cd 03.é¡¹ç›®å®æˆ˜/03_TODO_Web_API_FastAPI
from app.main import app

client = TestClient(app)


def test_ping():
    response = client.get("/ping")
    assert response.status_code == 200
```

ç­‰ä½ ä»¥åå†™å®Œ TODO é¡¹ç›®å¹¶ç†Ÿæ‚‰ pytestï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šè¡¥ä¸€å¥—ç®€å•çš„è‡ªåŠ¨åŒ–æ¥å£æµ‹è¯•ã€‚

---

## 05_æ•°æ®åˆ†ææ ˆæ¦‚è§ˆ

## 06_FastAPI é¡¹ç›®å¦‚ä½•ç¼–å†™ pytest æµ‹è¯•ï¼ˆå®æˆ˜å‘ï¼‰

è¿™é‡Œç»“åˆæœ¬ä»“åº“ä¸­çš„ä¸¤ä¸ªç¤ºä¾‹é¡¹ç›®ï¼Œæ€»ç»“ä¸€å¥—ç»™ FastAPI é¡¹ç›®å†™æµ‹è¯•çš„é€šç”¨æ€è·¯ï¼š

- ã€Œçº¯æ¥å£ + å†…å­˜/æµ‹è¯•æ•°æ®åº“ã€ï¼šå‚è€ƒ `03_TODO_Web_API_FastAPI/test_todo_api.py`ï¼›
- ã€Œå¯¹æ¥å¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚ Java æœåŠ¡ï¼‰ã€ï¼šå‚è€ƒ `03.é¡¹ç›®å®æˆ˜/08_ç³»ç»Ÿå¯¹æ¥_è°ƒç”¨JavaæœåŠ¡API/test_api_gateway_example.py`ã€‚

### 1. åŸºç¡€ç”¨æ³•ï¼šTestClient + ç®€å•æ¥å£

æœ€å°ç¤ºä¾‹ï¼ˆä¸æ¶‰åŠæ•°æ®åº“ï¼‰ï¼š

```python
from fastapi.testclient import TestClient

from app.main import app  # å‡è®¾ app.main ä¸­å®šä¹‰äº† app = FastAPI()

client = TestClient(app)


def test_ping() -> None:
    resp = client.get("/ping")
    assert resp.status_code == 200
    assert resp.json() == {"message": "pong"}
```

è¦ç‚¹ï¼š

- `TestClient` å°è£…äº† HTTP è°ƒç”¨é€»è¾‘ï¼Œæµ‹è¯•ä¸­ç›´æ¥è°ƒ `get/post` å³å¯ï¼›
- å°½é‡å¯¹æ¯ä¸ªæ¥å£å†™å‡ºã€Œä¸€ä¸ªæœ€å°ä½†å®Œæ•´çš„ happy pathã€æµ‹è¯•ç”¨ä¾‹ã€‚

### 2. å¸¦æ•°æ®åº“çš„æ¥å£æµ‹è¯•ï¼šè¦†ç›– get_db ä¾èµ–

åœ¨ TODO å®æˆ˜é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬**ä¸ç›´æ¥ä½¿ç”¨ç”Ÿäº§çš„ SQLite æ–‡ä»¶ `todo.db`**ï¼Œè€Œæ˜¯åœ¨æµ‹è¯•ä¸­åˆ›å»ºä¸€ä¸ª**å†…å­˜æ•°æ®åº“**ï¼Œå¹¶è¦†ç›– `get_db` ä¾èµ–ï¼š

```python
from typing import Generator

from fastapi.testclient import TestClient
from sqlalchemy import create_engine
from sqlalchemy.orm import Session, sessionmaker

from app.database import Base, get_db
from app.main import create_app


def _create_test_app() -> TestClient:
    """æ„é€ ä¸€ä¸ªä½¿ç”¨å†…å­˜ SQLite çš„æµ‹è¯•ç”¨ FastAPI åº”ç”¨ã€‚"""
    engine = create_engine(
        "sqlite:///:memory:", connect_args={"check_same_thread": False}
    )
    TestingSessionLocal = sessionmaker(
        autocommit=False, autoflush=False, bind=engine
    )

    Base.metadata.create_all(bind=engine)

    def override_get_db() -> Generator[Session, None, None]:
        db = TestingSessionLocal()
        try:
            yield db
        finally:
            db.close()

    app = create_app()
    app.dependency_overrides[get_db] = override_get_db
    return TestClient(app)
```

ç„¶ååœ¨æµ‹è¯•é‡Œä½¿ç”¨è¿™ä¸ª client åšå®Œæ•´çš„ CRUD æµ‹è¯•ï¼š

```python
def test_todo_crud_flow() -> None:
    client = _create_test_app()

    # åˆ›å»º TODO
    resp = client.post("/todos/", json={"title": "å­¦ä¹  FastAPI"})
    assert resp.status_code == 201
    created = resp.json()
    todo_id = created["id"]

    # æŸ¥è¯¢åˆ—è¡¨ / æ›´æ–° / åˆ é™¤ ...ï¼ˆå…·ä½“è§é¡¹ç›®ä¸­çš„ test_todo_api.pyï¼‰
```

è¿™ç§æ¨¡å¼å¯ä»¥å¤ç”¨åˆ°ä»»ä½•ã€Œéœ€è¦æ•°æ®åº“ã€çš„ FastAPI é¡¹ç›®ä¸­ï¼š

- åœ¨ `database.py` ä¸­å®šä¹‰ `Base` å’Œ `get_db`ï¼›
- åœ¨æµ‹è¯•ä¸­ç”¨å†…å­˜ DB æ›¿æ¢å®é™…è¿æ¥ï¼›
- é€šè¿‡ `dependency_overrides` æ³¨å…¥æµ‹è¯•ç”¨çš„ `get_db`ã€‚

### 3. å¸¦å¤–éƒ¨ç³»ç»Ÿçš„æ¥å£æµ‹è¯•ï¼šFake å®¢æˆ·ç«¯ + ä¾èµ–æ³¨å…¥

å¯¹äºã€Œè°ƒç”¨ Java æœåŠ¡ã€è¿™ç±»åœºæ™¯ï¼Œæµ‹è¯•æ—¶ä¸é€‚åˆçœŸçš„è°ƒ HTTPï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1. æŠŠå¯¹ Java çš„è°ƒç”¨å°è£…åˆ° `JavaServiceClient` ä¸­ï¼›
2. ç”¨ä¸€ä¸ª Fake ç‰ˆæœ¬çš„å®¢æˆ·ç«¯ï¼ˆ`FakeJavaClient`ï¼‰æ›¿ä»£çœŸå®å®¢æˆ·ç«¯ï¼›
3. åœ¨ FastAPI ä¸­é€šè¿‡ä¾èµ–æ³¨å…¥ç»Ÿä¸€è·å–å®¢æˆ·ç«¯ï¼›
4. åœ¨æµ‹è¯•ä¸­ç”¨ `dependency_overrides` è¦†ç›–ä¾èµ–ã€‚

ä»¥æœ¬ä»“åº“ä¸­çš„ç½‘å…³ç¤ºä¾‹ä¸ºä¾‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```python
# api_gateway_example.py
from fastapi import Depends, FastAPI

from client_java_service import JavaServiceClient


def get_java_client() -> JavaServiceClient:
    return JavaServiceClient.from_env()


app = FastAPI()


@app.get("/proxy/users/{user_id}")
def proxy_get_user(
    user_id: int, client: JavaServiceClient = Depends(get_java_client)
):
    return client.get_user(user_id)
```

æµ‹è¯•æ—¶å®šä¹‰ Fake å®¢æˆ·ç«¯ï¼Œå¹¶è¦†ç›– `get_java_client`ï¼š

```python
from fastapi.testclient import TestClient


class FakeJavaClient:
    def get_user(self, user_id: int) -> dict:
        return {"id": user_id, "name": "FakeUser"}


def _create_test_client() -> TestClient:
    import api_gateway_example as gw

    def override_get_java_client() -> FakeJavaClient:
        return FakeJavaClient()

    gw.app.dependency_overrides[gw.get_java_client] = override_get_java_client
    return TestClient(gw.app)


def test_proxy_get_user_success() -> None:
    client = _create_test_client()
    resp = client.get("/proxy/users/1")
    assert resp.status_code == 200
    assert resp.json()["data"]["id"] == 1
```

å®Œæ•´ç‰ˆæœ¬å¯ä»¥å‚è€ƒæœ¬ä»“åº“ä¸­çš„ï¼š

- `03.é¡¹ç›®å®æˆ˜/08_ç³»ç»Ÿå¯¹æ¥_è°ƒç”¨JavaæœåŠ¡API/test_client_java_service.py`
- `03.é¡¹ç›®å®æˆ˜/08_ç³»ç»Ÿå¯¹æ¥_è°ƒç”¨JavaæœåŠ¡API/test_api_gateway_example.py`

### 4. æ¨èå®è·µå°ç»“

- æŠŠã€Œå¤–éƒ¨ä¾èµ–ã€éƒ½æ”¶å£åˆ°å¯æ›¿æ¢çš„ä¾èµ–å‡½æ•°ä¸­ï¼ˆä¾‹å¦‚ `get_db`ã€`get_java_client`ï¼‰ï¼›
- åœ¨æµ‹è¯•ä¸­ä½¿ç”¨ï¼š
  - å†…å­˜æ•°æ®åº“ + `dependency_overrides`ï¼›
  - Fake å®¢æˆ·ç«¯ + `dependency_overrides`ï¼›
- æµ‹è¯•æ–‡ä»¶å‘½åç»Ÿä¸€é‡‡ç”¨ `test_*.py`ï¼Œå‡½æ•°åä»¥ `test_` å¼€å¤´ï¼Œæ–¹ä¾¿ pytest è‡ªåŠ¨å‘ç°ï¼›
- æµ‹è¯•å‡½æ•°å¼€å¤´ç”¨ä¸€ä¸¤å¥ä¸­æ–‡æ³¨é‡Šè¯´æ˜ã€Œè¿™ä¸ªæµ‹è¯•åœ¨éªŒè¯ä»€ä¹ˆã€ï¼Œæ–¹ä¾¿æ—¥åå›çœ‹æ—¶å¿«é€Ÿä¸Šæ‰‹ã€‚

---

## 05_æ•°æ®åˆ†ææ ˆæ¦‚è§ˆ

> è¿™éƒ¨åˆ†åœ¨ä½ å¼€å§‹åšä¸æ•°æ®ç›¸å…³çš„å°é¡¹ç›®æ—¶å†çœ‹å³å¯ã€‚

### 1. æ ¸å¿ƒåº“

- `numpy`ï¼šé«˜æ€§èƒ½å¤šç»´æ•°ç»„å’Œæ•°å€¼è®¡ç®—åŸºç¡€åº“ã€‚
- `pandas`ï¼šæ•°æ®åˆ†æä¸è¡¨æ ¼æ•°æ®å¤„ç†ï¼ˆç±»ä¼¼ Excel + SQL çš„ç»“åˆï¼‰ã€‚
- `matplotlib` / `seaborn`ï¼šæ•°æ®å¯è§†åŒ–ã€‚

### 2. pandas ç®€å•ç¤ºä¾‹

```python
# demo_pandas.py

import pandas as pd


def main():
    data = {
        "name": ["Alice", "Bob", "Charlie"],
        "age": [25, 30, 35],
        "salary": [10000, 12000, 15000],
    }
    df = pd.DataFrame(data)
    print(df)
    print("å¹³å‡å·¥èµ„ï¼š", df["salary"].mean())


if __name__ == "__main__":
    main()
```

å®‰è£…ä¾èµ–åè¿è¡Œï¼š

```bash
pip install pandas
python demo_pandas.py
```

---

## å­¦ä¹ é¡ºåºå»ºè®®ï¼ˆç»“åˆé¡¹ç›®å®æˆ˜ï¼‰

- å®Œæˆ `01.Pythonè¯­è¨€åŸºç¡€` â†’ æŒæ¡è¯­æ³•
- é˜…è¯»æœ¬ç« èŠ‚ï¼š
  1. `01_å¼€å‘å·¥å…·ä¸äº¤äº’ç¯å¢ƒ`
  2. `02_è™šæ‹Ÿç¯å¢ƒä¸ä¾èµ–ç®¡ç†`
  3. `03_é¡¹ç›®ç»“æ„ä¸ä»£ç ç»„ç»‡`
  4. å†è§†å…´è¶£é€‰æ‹©ï¼š
     - èµ° Web è·¯çº¿ï¼šæ·±å…¥ `FastAPI`ï¼Œé…åˆ `03.é¡¹ç›®å®æˆ˜` ä¸­çš„ Web é¡¹ç›®
     - èµ°æ•°æ®è·¯çº¿ï¼šå­¦ä¹  `pandas`ï¼Œé…åˆ `03.é¡¹ç›®å®æˆ˜` ä¸­çš„æ•°æ®åˆ†æé¡¹ç›®
